<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³µì •ìœ„ ë¸”ë¡œê·¸ ê²€ì‚¬ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ ê³µì •ìœ„ ë¸”ë¡œê·¸ ê²€ì‚¬ê¸°</h1>
    
    <!-- ë¸”ë¡œê·¸ ID ì…ë ¥ -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">ë¸”ë¡œê·¸ ID ì…ë ¥:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 border rounded px-3 py-2" placeholder="ì˜ˆ: chomossi_record" />
        <button onclick="fetchBlogPosts()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">ê²€ì‚¬ ì‹œì‘</button>
      </div>
    </div>

    <!-- ê³µì •ìœ„ ë„ë©”ì¸ ê´€ë¦¬ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">âš™ï¸ ê³µì •ìœ„ ì´ë¯¸ì§€ ë„ë©”ì¸ ì„¤ì •</h2>
      <div class="flex gap-2 mb-2">
        <input id="fairLinkInput" type="text" placeholder="ì˜ˆ: reviewnote.co.kr/gongjeong/" class="flex-1 border rounded px-2 py-1 text-sm" />
        <button onclick="addFairLink()" class="bg-blue-600 text-white px-3 py-1 text-sm rounded">ì¶”ê°€</button>
      </div>
      <ul id="fairLinkList" class="text-sm text-gray-700 space-y-1"></ul>
    </section>

    <!-- ê²°ê³¼ í‘œì‹œ -->
    <ul id="postList" class="space-y-4"></ul>
  </div>

  <script>
    // ì „ì—­ ë¦¬ìŠ¤íŠ¸
    let fairTradeImageLinks = [
      "xn--939au0g4vj8sq.net",
      "blogmall.net/campaign/blogWidget",
      "d3i7y4ugnppb9p.cloudfront.net/contract/track/",
      "www.reviewnote.co.kr/gongjeong/",
      "dinnerqueen.net/reviews/image/",
      "revu.net/campaign/"
    ];

    // ë Œë”ë§
    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";
      fairTradeImageLinks.forEach((link, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${idx + 1}. ${link}
          <button onclick="removeFairLink(${idx})" class="ml-2 text-red-500 text-xs">âŒ</button>
        `;
        list.appendChild(li);
      });
    }

    // ì¶”ê°€
    function addFairLink() {
      const input = document.getElementById("fairLinkInput");
      const value = input.value.trim();
      if (!value) return;
      if (fairTradeImageLinks.includes(value)) {
        alert("ì´ë¯¸ ë“±ë¡ëœ ë§í¬ì…ë‹ˆë‹¤.");
        return;
      }
      fairTradeImageLinks.push(value);
      input.value = "";
      renderFairLinks();
    }

    // ì œê±°
    function removeFairLink(index) {
      fairTradeImageLinks.splice(index, 1);
      renderFairLinks();
    }

    // ì´ˆê¸° ë Œë”
    renderFairLinks();

    // ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    async function fetchBlogPosts() {
    const blogId = document.getElementById("blogId").value.trim();
    if (!blogId) {
        alert("ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    try {
        //const response = await fetch("http://localhost:3000/analyze_blog", {
        const response = await fetch("https://fairblog.onrender.com/analyze_blog", {

        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            blogId,
            fairTradeImageLinks
        })
        });

        if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
        const data = await response.json();
        renderPosts(data.posts);
    } catch (err) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", err);
        alert("ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}


    // í¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderPosts(posts) {
      const list = document.getElementById("postList");
      list.innerHTML = "";

      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const isSuspicious = hasFair && post.fair_trade_img_position !== 1;
        const useFairImage = post.fair_trade_img_url && post.fair_trade_img_position === 1;
        const imageSrc = useFairImage ? post.fair_trade_img_url : post.first_image_url;
        const proxyImageSrc = `http://localhost:3000/proxy?url=${encodeURIComponent(imageSrc)}`;

        // ìƒíƒœ íƒœê·¸ êµ¬ì„±
        let tag = '';
        if (hasFair && post.fair_trade_img_position === 1) {
          tag = `<span class="inline-block text-green-700 bg-green-100 text-sm px-2 py-1 rounded">âœ… ê³µì •ìœ„ ì´ë¯¸ì§€ (ì •ìƒ)</span>`;
        } else if (hasFair && post.fair_trade_img_position !== 1) {
          tag = `<span class="inline-block text-red-700 bg-red-100 text-sm px-2 py-1 rounded">â— ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ, ì²« ë²ˆì§¸ ì•„ë‹˜</span>`;
        } else {
          tag = `<span class="inline-block text-gray-600 bg-gray-100 text-sm px-2 py-1 rounded">ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ</span>`;
        }

        // ì¹´ë“œ ìƒì„±
        const li = document.createElement("li");
        li.className = "border rounded-md p-4 mb-4 bg-white shadow-sm";

        li.innerHTML = `
          <div class="flex gap-4 items-start">
            <img
                src="${proxyImageSrc}"
                alt="ì¸ë„¤ì¼"
                class="w-24 h-24 object-contain bg-gray-100 border rounded-md"
                style="user-select: none;"
                onerror="this.style.display='none'"
            />
            <div class="flex-1">
              <h2 class="text-lg font-semibold"><a href="${post.url}" target="_blank" class="hover:underline">${post.title}</a></h2>
              <p class="text-sm text-gray-500">${post.date}</p>
              ${!hasFair ? `<p class="text-sm mt-1 text-gray-700">${post.first_100_chars}</p>` : ''}
              <p class="mt-2">${tag}</p>
            </div>
          </div>
        `;

        list.appendChild(li);
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>공정위 블로그 검사기</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">📝 공정위 블로그 검사기</h1>
    
    <!-- 블로그 ID 입력 -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">블로그 ID 입력:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 border rounded px-3 py-2" placeholder="예: blogpeople" />
        <div class="flex items-center gap-1 text-sm">
          <label for="pageNum" class="text-gray-600"> </label>

          <select id="pageNum" class="border rounded px-2 py-1 text-sm">
            <option value="1" selected>1페이지</option>
            <option value="2">2페이지</option>
            <option value="3">3페이지</option>
            <option value="4">4페이지</option>
            <option value="5">5페이지</option>
            <option value="6">6페이지</option>
            <option value="7">7페이지</option>
            <option value="8">8페이지</option>
            <option value="9">9페이지</option>
            <option value="10">10페이지</option>
          </select>

          <span class="text-gray-600">탐색</span>
          <!-- ✅ 선택 결과 안내 -->
        </div>
        <button onclick="fetchBlogPosts()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">검사 시작</button>
      </div>
    </div>

    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <div id="tagFilter" class="mb-4 flex flex-wrap gap-2">
      <button onclick="filterByTag('전체')" class="px-3 py-1 bg-gray-300 rounded">전체</button>
      <button onclick="filterByTag('공정위 이미지 있음')" class="px-3 py-1 bg-gray-300 rounded">공정위 이미지 있음</button>
      <button onclick="filterByTag('공정위 이미지 없음')" class="px-3 py-1 bg-gray-300 rounded">공정위 이미지 없음</button>
      <button onclick="filterByTag('상단 배치')" class="px-3 py-1 bg-gray-300 rounded">상단 배치</button>
      <button onclick="filterByTag('하단 배치')" class="px-3 py-1 bg-gray-300 rounded">하단 배치</button>
      <button onclick="filterByTag('스티커 있음')" class="px-3 py-1 bg-gray-300 rounded">스티커 있음</button>
      <button onclick="filterByTag('스티커 없음')" class="px-3 py-1 bg-gray-300 rounded">스티커 없음</button>
    </div>


    <!-- 결과 표시 -->
    <ul id="postList" class="space-y-4"></ul>
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">📄 신고용 요약 TXT</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT 다운로드</button>
    </section>

    <!-- 공정위 도메인 관리 -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">⚙️ 공정위 이미지 도메인 설정</h2>
      <div class="flex gap-2 mb-2">
        <input id="fairLinkInput" type="text" placeholder="예: reviewnote.co.kr/gongjeong/" class="flex-1 border rounded px-2 py-1 text-sm" />
        <button onclick="addFairLink()" class="bg-blue-600 text-white px-3 py-1 text-sm rounded">추가</button>
      </div>
      <ul id="fairLinkList" class="text-sm text-gray-700 space-y-1"></ul>
    </section>

  </div>

  <script>
    
    const isTestMode = false;

    // 전역 리스트
    let fairTradeImageLinks = [
      "강남맛집.net",                     //강남맛집 1
      "xn--939au0g4vj8sq.net",           //강남맛집 2
      "blogmall.net/",                   //미블
      "d3i7y4ugnppb9p.cloudfront.net/",  //슈퍼멤버스
      "www.reviewnote.co.kr/",           //리뷰노트
      "dinnerqueen.net/",                //디너의여왕
      "revu.net/",                       //레뷰
      "reviewplace.co.kr/",              //리뷰플레이스
      "mateb.kr/",                       //기타체험단
      "postfiles.pstatic.net/"           //클라우드리뷰
    ];

    // 렌더링
    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";
      fairTradeImageLinks.forEach((link, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${idx + 1}. ${link}
          <button onclick="removeFairLink(${idx})" class="ml-2 text-red-500 text-xs">❌</button>
        `;
        list.appendChild(li);
      });
    }

    // 추가
    function addFairLink() {
      const input = document.getElementById("fairLinkInput");
      const value = input.value.trim();
      if (!value) return;
      if (fairTradeImageLinks.includes(value)) {
        alert("이미 등록된 링크입니다.");
        return;
      }
      fairTradeImageLinks.push(value);
      input.value = "";
      renderFairLinks();
    }

    // 제거
    function removeFairLink(index) {
      fairTradeImageLinks.splice(index, 1);
      renderFairLinks();
    }

    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
    }

    // 초기 렌더
    renderFairLinks();

    /*
    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      if (!blogId) {
        alert("블로그 ID를 입력해주세요.1");
        return;
      }

      showLoading();
      try {
        const postListRes = await fetch(`https://m.blog.naver.com/api/blogs/${blogId}/post-list?categoryNo=0&itemCount=24&page=1&userId=${blogId}`, {
          headers: {
            'User-Agent': 'Mozilla/5.0',
            'Accept': 'application/json',
            'Referer': `https://m.blog.naver.com/${blogId}`
          }
        });

        const postData = await postListRes.json();
        const items = postData.result?.items || [];

        const allPosts = [];
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const postUrl = `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`;


          if (isTestMode) {
            analyze_single = "http://localhost:3000/analyze_single";
          } else {
            analyze_single = "https://fairblog.onrender.com/analyze_single";
          }

          const res = await fetch(analyze_single, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              postUrl,
              fairTradeImageLinks
            })
          });

          if (res.ok) {
            const parsed = await res.json();
            allPosts.push(parsed);
          }

          // 프로그레스바 업데이트
          updateProgress(i + 1, items.length);
        }

        renderPosts(allPosts);
        renderTxt(allPosts);
      } catch (err) {
        console.error("전체 분석 실패:", err);
        alert("블로그 분석 중 오류가 발생했습니다.");
      } finally {
        hideLoading();
      }
    }
    */

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    // 포스트 렌더링
    function renderPosts(posts) {
      const list = document.getElementById("postList");
      list.innerHTML = "";

      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const isSuspicious = hasFair && post.fair_trade_img_position !== 1;
        const useFairImage = post.fair_trade_img_url && post.fair_trade_img_position === 1;
        const imageSrc = useFairImage ? post.fair_trade_img_url : post.first_image_url;
        
        // ✅ 강남맛집.net 포함 시 무조건 고정 URL로 대체
        if (imageSrc.includes("강남맛집.net")) {
          imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
        }

        let BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
        const encodedUrl = encodeURIComponent(imageSrc);
        const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
        
        console.log("✅ 최종 요청 URL:", encodedUrl);

        // 태그 박스 목록 준비
        const tagList = [];

        if (hasFair) {
          tagList.push({ text: "✅ 공정위 이미지 있음", class: "text-green-700 bg-green-100" });

          if (post.fair_trade_img_position === 1) {
            tagList.push({ text: "📌 상단 배치", class: "text-blue-700 bg-blue-100" });
          } else {
            tagList.push({ text: "❗ 하단 배치", class: "text-red-700 bg-red-100" });
          }
        } else {
          tagList.push({ text: "🚫 공정위 이미지 없음", class: "text-gray-700 bg-gray-100" });
        }

        if (post.first_image_url?.includes("sticker")) {
          tagList.push({ text: "🏷️ 스티커 있음", class: "text-yellow-700 bg-yellow-100" });
        } else {
          tagList.push({ text: "스티커 없음", class: "text-gray-500 bg-gray-100" });
        }

        // DOM으로 각각의 span 요소 생성해서 p에 붙이기
        const tagContainer = document.createElement("p");
        tagContainer.className = "mt-2 flex flex-wrap gap-2";

        const tagTextsForFilter = []; // 필터링용 문자열 모음

        tagList.forEach(tag => {
          const span = document.createElement("span");
          span.className = `inline-block text-sm px-2 py-1 rounded ${tag.class}`;
          span.textContent = tag.text;
          tagContainer.appendChild(span);

          const plainText = tag.text.replace(/^[^가-힣a-zA-Z]+/, '').trim(); 
          tagTextsForFilter.push(plainText);
        });

        // 카드 생성
        const li = document.createElement("li");
        li.className = "border rounded-md p-4 mb-4 bg-white shadow-sm";

        li.innerHTML = `
          <div class="flex gap-4 items-start">
            <img
              src="${proxyImageSrc}"
              alt="썸네일"
              class="w-24 h-24 sm:w-32 sm:h-32 object-cover bg-gray-100 border rounded-md"
              style="user-select: none;"
              onerror="this.style.display='none'"
            />
            <div class="flex-1">
              <h2 class="text-lg font-semibold"><a href="${post.url}" target="_blank">${post.title}</a></h2>
              <p class="text-sm text-gray-500">${post.date}</p>
              ${!hasFair ? `<p class="text-sm mt-1 text-gray-700">${post.first_100_chars}</p>` : ''}
            </div>
          </div>
        `;
        
        // li 안의 .flex-1 영역에 tagContainer 추가
        li.querySelector(".flex-1").appendChild(tagContainer);
        li.setAttribute("data-tags", tagTextsForFilter.join(" "));
        list.appendChild(li);
      });
    }

    function renderTxt(posts) {
      const suspiciousPosts = posts.filter(p =>
        p.fair_trade_img_url && p.fair_trade_img_position !== 1
      );

      let txt = "📌 [공정위 문구 있음 + 첫 번째 아님 → 의심 게시글]\n";
      txt += `총 ${suspiciousPosts.length}건\n`;
      txt += "────────────────────────────\n\n";

      suspiciousPosts.forEach((p, idx) => {
        txt += `${idx + 1}) ${p.title || "(제목 없음)"}\n`;
        txt += `   📎 링크: ${p.url}\n`;
        txt += `   🖼️ 위치: ${p.fair_trade_img_position}번째\n`;
        txt += `   🔗 이미지: ${p.fair_trade_img_url}\n\n`;
      });

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "전체" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }


    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");

      if (!blogId) {
        alert("블로그 ID를 입력해주세요.2");
        return;
      }

      showLoading(); // ✅ 시작 시 표시

      if (isTestMode) {
        analyze_blog = "http://localhost:3000/analyze_blog";
      } else {
        analyze_blog = "https://fairblog.onrender.com/analyze_blog";
      }

      try {
        const response = await fetch(analyze_blog, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            blogId,
            fairTradeImageLinks,
            numPages: pageNum  // ✅ 사용자 입력값을 함께 보냄
          })
        });

        if (!response.ok) throw new Error("네트워크 오류");
      
        if (response.status === 429) {
          alert("❗ 요청이 너무 많아 분석이 일시적으로 차단되었습니다.\n잠시 후 다시 시도해주세요.");
          return;
        }

        const data = await response.json();
        renderPosts(data.posts);
        renderTxt(data.posts);

      } catch (err) {
        console.error("분석 오류:", err);
        alert("분석 중 오류가 발생했습니다.");
      } finally {
        hideLoading(); // ✅ 항상 숨김
      }
    }

  </script>
</body>
</html>

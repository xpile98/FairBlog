<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>공정위 문구 검사기 - 페어블로그</title>
  <meta name="description" content="공정위 문구를 자동으로 분석하는 네이버 블로그 체험단 광고 표시 검사 도구입니다.">
  <meta name="keywords" content="공정위 문구 검사, 광고 문구 분석, 네이버 블로그 체험단, SNS 광고, 표시광고 심사 지침">
  <meta name="author" content="yongwon cho">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="qoyiCn5HdEafxTpuvuTjg9UAPNcl__rm0N85A-RChtU" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>


  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YRHK2QVDMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-YRHK2QVDMT');
  </script>
</head>

<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <section class="text-center text-gray-700 my-6">
      <h1 onclick="location.reload()"
        class="text-2xl font-extrabold text-blue-600 hover:text-blue-800 transition-colors duration-200 text-center block cursor-pointer">
        <span class="block sm:inline">공정위 문구 검사기</span>
        <span class="block sm:inline">페어블로그</span>
      </h1>
      <p class="text-sm text-gray-600 mt-2">
        공정위 표시광고 가이드에 따라 네이버 블로그 체험단 문구를 자동 분석하는 무료 도구입니다.
      </p>
    </section>

    <!-- 전체 그룹 -->
    <div class="flex flex-wrap items-end gap-4 mb-4 text-sm">

      <!-- 1행: 블로그 ID 입력 -->
      <div class="flex flex-col w-full">
        <label for="blogId" class="mb-1 text-gray-700">네이버 블로그 ID 입력:</label>
        <input type="text" id="blogId" class="h-[42px] px-3 border rounded text-sm w-full"
          placeholder="예: blogpeople" />
      </div>

      <!-- 2행: 페이지 + OCR + 버튼 -->
      <div class="flex flex-wrap items-end gap-4 w-full">

        <!-- 페이지 선택 -->
        <div class="flex items-center gap-2">
          <label for="pageNum" class="text-gray-700 whitespace-nowrap">페이지</label>
          <select id="pageNum" class="w-[80px] h-[38px] px-2 border rounded">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
          </select>
        </div>

        <!-- OCR + 다중 페이지 분석 토글 -->
        <div class="flex flex-wrap gap-4 sm:gap-8">
          <!-- OCR 토글 -->
          <div class="flex items-center gap-4 w-full sm:w-auto">
            <label for="detailedCheck" class="text-gray-700 whitespace-nowrap">
              이미지 문구 분석 <span class="text-gray-400 text-xs">(몇 초 소요)</span>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="detailedCheck" class="sr-only peer" checked />
              <div class="w-10 h-5 bg-gray-300 rounded-full peer-checked:bg-green-600 transition-colors"></div>
              <div
                class="absolute left-0.5 top-0.5 w-4 h-4 bg-white border rounded-full transition-transform peer-checked:translate-x-5">
              </div>
            </label>
          </div>

          <!-- 연속 분석 토글 -->
          <div class="flex items-center gap-4 w-full sm:w-auto">
            <label for="multiPageCheck" class="text-gray-700 whitespace-nowrap">
              1페이지부터 연속 분석
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="multiPageCheck" class="sr-only peer" />
              <div class="w-10 h-5 bg-gray-300 rounded-full peer-checked:bg-green-600 transition-colors"></div>
              <div
                class="absolute left-0.5 top-0.5 w-4 h-4 bg-white border rounded-full transition-transform peer-checked:translate-x-5">
              </div>
            </label>
          </div>
        </div>


        <!-- 검사 시작 버튼 -->
        <div class="flex-1 min-w-[120px]">
          <button id="startBtn" onclick="fetchBlogPosts()"
            class="w-full h-[42px] bg-blue-600 text-white px-5 rounded hover:bg-blue-700 transition whitespace-nowrap">
            검사 시작
          </button>
        </div>

      </div>

    </div>




    <div id="loadingText" class="mt-2 text-sm text-blue-700 hidden">분석 대기 중...</div>
    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 mb-6 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <!-- 정렬 방식 + 보기 방식 (한 행 드롭다운) -->
    <div class="flex flex-wrap items-end gap-4 mb-4 text-sm">

      <!-- 정렬 방식 -->
      <div class="flex flex-col">
        <label for="tagFilterSelect" class="mb-1 font-semibold text-gray-700">🧭 정렬 방식</label>
        <select id="tagFilterSelect" onchange="filterByTag(this.value)" class="w-[140px] h-[36px] px-2 border rounded">
          <option value="전체">전체</option>
          <option value="정책 지킴">정책 지킴</option>
          <option value="정책 위반">정책 위반</option>
          <option value="내돈내산">내돈내산</option>
          <option value="불분명">불분명</option>
        </select>
      </div>

      <!-- 보기 방식 -->
      <div class="flex flex-col">
        <label for="viewModeSelect" class="mb-1 font-semibold text-gray-700">🖼 보기 방식</label>
        <select id="viewModeSelect" onchange="setViewMode(this.value)" class="w-[140px] h-[36px] px-2 border rounded">
          <option value="list">☰ 리스트</option>
          <option value="grid">🔲 그리드</option>
          <option value="summary">📄 요약</option>
        </select>
      </div>

    </div>


    <!-- 결과 표시: 요약 보기 모드에서만 표시 -->
    <section id="summaryBox" class="mt-8 hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">📄 요약 보기</h2>
        <div class="flex items-center space-x-4">
          <label class="text-sm flex items-center space-x-1">
            <input type="checkbox" id="violationOnlyCheckbox" onchange="renderTxt(window.latestPosts)">
            <span>🔴 위반만 보기</span>
          </label>
          <label class="text-sm flex items-center space-x-1">
            <span>🌐 도메인 필터:</span>
            <select id="domainFilterSelect" class="border rounded p-1 text-sm" onchange="renderTxt(window.latestPosts)">
              <option value="all">전체</option>
            </select>
          </label>
        </div>
      </div>
      <pre id="reportContent"
        class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT 다운로드</button>
      <button onclick="copyToClipboard()" class="bg-blue-600 text-white px-4 py-2 rounded">클립보드에 복사</button>
    </section>




    <!-- 결과 표시 -->
    <ul id="postList" class="w-full max-w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch"></ul>

    <!-- 이건 ul 밖으로 빼야 .innerHTML 영향을 안 받음 -->
    <div id="emptyMessage" class="text-center text-gray-500 py-10">
      🔍 결과가 이곳에 표시됩니다. 상단에서 블로그 ID를 입력하세요.
    </div>

    <!-- 공정위 도메인 관리 -->
    <section class="mt-8 mb-6">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">⚙️ 공정위 이미지 도메인 목록</h2>
      <div class="bg-gray-50 border rounded px-4 py-3">
        <ul id="fairLinkList" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-700 list-none p-0 m-0"></ul>
      </div>
    </section>

    <!-- 정책 문구 키워드 안내 -->
    <section class="mt-8">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">📌 공정위 키워드 목록</h2>
      <!-- 협찬 문구 키워드 -->
      <div class="mb-4">
        <h3 class="text-xs font-medium text-green-700 mb-1">🟢 협찬 문구 키워드</h3>
        <div id="sponsoredKeywordTags" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- 내돈내산 키워드 -->
      <div>
        <h3 class="text-xs font-medium text-blue-700 mb-1">🔵 내돈내산 키워드</h3>
        <div id="nonSponsoredKeywordTags" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- 테스트/운영 모드 상태 표시 -->
    <div id="buildModeLabel"
      class="fixed bottom-2 left-2 text-xs text-white bg-gray-500 px-2 py-1 rounded opacity-70 z-50">
      모드 표시 중...
    </div>

    <!-- 우측 상단 고정 로그인/로그아웃 버튼 -->
    <div id="adminAuth" class="fixed top-2 right-2 z-50 space-x-2">
      <button id="loginBtn" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">🔐 로그인</button>
      <button id="logoutBtn" class="hidden text-xs bg-gray-600 text-white px-2 py-1 rounded">🚪 로그아웃</button>
    </div>

    <!-- 이미지 모달 뷰어 -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
      <img id="modalImage" src="" alt="확대 이미지" class="max-w-[90vw] max-h-[90vh] rounded shadow-lg border bg-white" />
    </div>


    <!-- 토글 버튼 -->
    <button onclick="toggleGuestbook()" class="fixed bottom-4 right-4 z-50 bg-blue-600 text-white px-3 py-2 rounded">
      💬 방명록
    </button>

    <!-- ✅ 모바일: hidden, PC: block -->
    <div id="guestbook" class="hidden fixed top-20 right-4 w-72 bg-white border rounded shadow-lg p-4 z-50 text-sm"
      style="top: 200px;">
      <!-- 상단: 제목 + 닫기 버튼 -->
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-bold">📓 방명록</h3>
        <button onclick="toggleGuestbook()" class="text-gray-400 hover:text-red-500 text-lg font-bold">&times;</button>
      </div>

      <form id="guestbookForm" class="mb-2">
        <input id="nickname" type="text" placeholder="닉네임" class="w-full mb-1 px-2 py-1 border rounded" />
        <textarea id="message" placeholder="한 줄 메시지" class="w-full px-2 py-1 border rounded"></textarea>
        <button type="submit" class="mt-2 w-full bg-blue-600 text-white px-2 py-1 rounded">작성</button>
      </form>
      <ul id="guestbookList" class="space-y-1 max-h-48 overflow-auto text-xs text-gray-700"></ul>
    </div>


    <!-- 로그인 모달 -->
    <div id="loginFormBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white border rounded shadow-lg p-6 w-80 relative">
        <!-- ✅ 닫기 버튼 -->
        <button id="closeLoginBtn"
          class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl font-bold">&times;</button>

        <h3 class="text-lg font-semibold mb-4 text-center">🔐 관리자 로그인</h3>
        <form id="loginForm" class="space-y-3">
          <input id="loginEmail" type="email" placeholder="이메일" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <input id="loginPassword" type="password" placeholder="비밀번호" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <button type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">로그인</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const isTestMode = location.origin.includes("127.0.0.1") || location.origin.includes("localhost");

    const modeLabel = document.getElementById("buildModeLabel");
    if (isTestMode) {
      modeLabel.textContent = "🧪 테스트 모드 (로컬)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-yellow-600");
    } else {
      modeLabel.textContent = "✅ 최종 빌드 (20250522_1330)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-green-700");
    }

    const fairDomainAliasMap = {
      "강남맛집.net": "강남맛집",
      "xn--939au0g4vj8sq.net": "강남맛집",
      "%EA%B0%95%EB%82%A8%EB%A7%9B%EC%A7%91.net": "강남맛집",
      "blogmall.net": "미블",
      "mrble1": "미블",
      "d3i7y4ugnppb9p.cloudfront.net": "슈퍼멤버스",
      "reviewnote": "리뷰노트",
      "dinnerqueen.net": "디너의여왕",
      "revu.net": "레뷰",
      "reviewplace.co.kr": "리뷰플레이스",
      "nugunablog.co.kr": "클라우드리뷰",
      "tble.kr": "티블",
      "seoulouba.co.kr": "서울오빠",
      "dailyview.kr": "데일리뷰",
      "assaview.co.kr": "아싸뷰",
      "ringble.co.kr": "링블",
      "blogdexreview.space": "블덱스",
      "chvu_01.jpg": "체험뷰",
      "chvu_02.jpg": "체험뷰",
      "chvu_03.jpg": "체험뷰",
      "cometoplay.kr": "놀러와",
      "가보자체험단.com": "가보자",
      "xn--o39a04kpnjo4k9hgflp.com": "가보자",
      "sioneview.com": "시원뷰",
      "kormedia.co.kr": "오마이블로그",
      "블로그원정대.com": "블로그원정대",
      "xn--2i0bl9gt7ekxgr7lzzb.com": "블로그원정대",
      "모두모여체험단.com": "모두모여",
      "xn--6j1br0ag3lba435lvsj96p.com": "모두모여",
      "rewview.co.kr": "르뷰",
      "popomon": "포포몬",
      "4blog": "포블로그",
      "dinodan": "디노단",
      "cashnote": "캐시노트",
      "unnispick.com": "언니스픽",
      "mateb.kr": "기타체험단"
    };
    //포블로그, 포포몬, 디노단, 캐시노트 우리가게체험단, 

    const sponsoredKeywords = [
      "제공받",     // 제품을 제공받아, 서비스 제공받아 등
      "광고",       // 유료광고, 광고포함, 광고지만 등
      "협찬",       // 협찬을 통해, 협찬받아 등
      "무상",       // 무상제공, 무상으로 등
      "제품을",     // 제품을 제공받아 등
      "업체로부터", // 업체로부터 제공받아
      "파트너스",   // 파트너스 활동
      "이벤트",     // 이벤트 당첨
      "의벤트",     // 오탈자 대응
      "유료광고",   // 명시적 광고 표기
      "원고료",     // 원고료 제공 등
      "수수료",     // 수수료 제공, 지급 등
      "숙박권",
      "체험단",
      "체험",
      "식사권",
      "당첨되어",
      "초대권",
      "제휴링크",
      "적립금",
      "홍보지원금",
      "경제적대가"
    ];

    const nonSponsoredKeywords = [
      "내돈내산",
      "내돈내먹",
      "직접구매",
      "직접결제",
      "제돈으로",
      "광고아님",
      "광고없는",
      "대가없이"
    ];

    function isSponsored(text) {
      if (!text) return false;
      return sponsoredKeywords.some(keyword => text.includes(keyword));
    }

    function isNonSponsored(text) {
      if (!text) return false;
      return nonSponsoredKeywords.some(keyword => text.includes(keyword));
    }

    function getDomainAlias(imageUrl) {
      for (const domain in fairDomainAliasMap) {
        if (imageUrl.includes(domain)) {
          return fairDomainAliasMap[domain];
        }
      }
      return "기타/알 수 없음";
    }

    //function renderFairLinks() {
    //  const list = document.getElementById("fairLinkList");
    //  list.innerHTML = "";
    //
    //  Object.entries(fairDomainAliasMap).forEach(([domain, name], idx) => {
    //    const li = document.createElement("li");
    //    li.innerHTML = `${idx + 1}. <strong>${name}</strong> <span class="text-gray-500 text-sm">(${domain})</span>`;
    //    list.appendChild(li);
    //  });
    //}

    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";

      const basePath = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');

      const seenNames = new Set();  // 중복 제거용

      Object.entries(fairDomainAliasMap).forEach(([domain, name]) => {
        if (seenNames.has(name)) return;  // 중복된 이름은 건너뜀
        seenNames.add(name);

        const a = document.createElement("a");
        a.href = `http://${domain}`;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "inline-block box-border p-[5px_8px_6px] border border-gray-200 rounded-[6px] text-center w-20 h-10 flex items-center justify-center text-xs font-semibold text-gray-600";

        a.onclick = (e) => e.preventDefault();  // ✅ 링크 클릭 방지

        const img = new Image();
        img.src = `${basePath}/img/${name}.png`;
        img.alt = name;
        img.className = "w-full h-full object-contain";

        img.onload = () => {
          a.textContent = "";
          a.appendChild(img);
        };

        img.onerror = () => {
          a.textContent = name;
        };

        list.appendChild(a);
      });
    }

    function renderKeywordTags() {
      const sponsorBox = document.getElementById("sponsoredKeywordTags");
      const nonSponsorBox = document.getElementById("nonSponsoredKeywordTags");

      sponsorBox.innerHTML = "";
      nonSponsorBox.innerHTML = "";

      sponsoredKeywords.forEach(keyword => {
        const span = document.createElement("span");
        span.textContent = keyword;
        span.className = "bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded";
        sponsorBox.appendChild(span);
      });

      nonSponsoredKeywords.forEach(keyword => {
        const span = document.createElement("span");
        span.textContent = keyword;
        span.className = "bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded";
        nonSponsorBox.appendChild(span);
      });
    }


    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingText").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
      document.getElementById("loadingText").classList.add("hidden");
    }

    // 초기 렌더
    renderFairLinks();
    renderKeywordTags();

    function updateProgress(current, total) {
      const percent = (current / total) * progressSplit.analysis;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    function updateOcrProgress(current, total) {
      const percent = progressSplit.ocr > 0
        ? progressSplit.analysis + (current / total) * progressSplit.ocr
        : 100;
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    let progressSplit = { analysis: 70, ocr: 30 }; // 기본값

    let currentViewMode = 'list';
    let globalPostData = [];

    function setProgressSplit(useDetailedCheck) {
      progressSplit = useDetailedCheck
        ? { analysis: 70, ocr: 30 }
        : { analysis: 100, ocr: 0 };
    }
    // 포스트 렌더링
    function renderPosts(posts) {
      //console.log("📦 renderPosts 진입 - 현재 보기 모드:", currentViewMode);

      const list = document.getElementById("postList");
      list.innerHTML = "";

      if (posts.length === 0) {
        document.getElementById("emptyMessage").classList.remove("hidden");
      } else {
        document.getElementById("emptyMessage").classList.add("hidden");
      }

      function highlightSponsoredKeywords(text) {
        if (!text) return "";
        let safeText = text; // 변형 없이 시작
        sponsoredKeywords.forEach(keyword => {
          const pattern = new RegExp(`(${keyword})`, "gi");
          safeText = safeText.replace(pattern, '<mark class="bg-yellow-200">$1</mark>');
        });
        return safeText;
      }

      function highlightNonSponsoredKeywords(text) {
        if (!text) return "";
        let safeText = text; // 변형 없이 시작
        nonSponsoredKeywords.forEach(keyword => {
          const pattern = new RegExp(`(${keyword})`, "gi");
          safeText = safeText.replace(pattern, '<mark class="bg-yellow-200">$1</mark>');
        });
        return safeText;
      }


      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const useFairImage = hasFair;// && post.fair_trade_img_position === 1;
        const hasSticker = post.first_image_url?.includes("storep-phinf");

        // ✅ 우선순위: 공정위 상단 이미지 > 스티커 이미지 > 일반 썸네일
        let imageSrc = useFairImage
          ? post.fair_trade_img_url
          : hasSticker
            ? post.first_image_url
            : post.first_image_url;

        if (imageSrc.includes("강남맛집.net")) {
          imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
        }

        if (!useFairImage && imageSrc.includes("type=w") && imageSrc.includes("_blur")) {
          imageSrc = imageSrc.replace(/type=w\d+_blur/, "type=w800").replace(/([?&])type=w\d+_blur/, "$1type=w800"); // 쿼리도 포함 처리
        }

        const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
        const isNaverPostImage = imageSrc.includes("pstatic.net");

        const encodedUrl = encodeURIComponent(imageSrc);
        const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;

        //const finalImageUrl = useFairImage ? imageSrc : proxyImageSrc;
        //const finalImageUrl = proxyImageSrc;
        const finalImageUrl = !isNaverPostImage ? imageSrc : proxyImageSrc;

        // 태그 정리
        const tagList = [];
        const tagTextsForFilter = [];

        const lowerTitle = (post.title || "").toLowerCase();
        const lowerText = (post.first_100_chars || "").toLowerCase();
        const lowerOcr = (post.first_ocr_text || "").toLowerCase();

        const hasSponsoredT = isSponsored(lowerText) || isSponsored(lowerTitle);
        const hasSponsoredO = isSponsored(lowerOcr);

        const hasNonSponsoredT = isNonSponsored(lowerText) || isNonSponsored(lowerTitle);
        const hasNonSponsoredO = isNonSponsored(lowerOcr);

        if (hasFair) {
          if (post.fair_trade_img_position === 1) {
            tagList.push({ text: "정책 지킴 (공정위 이미지)", class: "bg-green-100 text-green-800" });
            tagTextsForFilter.push("정책 지킴");
          } else {
            tagList.push({ text: "정책 위반 (공정위 이미지)", class: "bg-red-100 text-red-800" });
            tagTextsForFilter.push("정책 위반");
          }
        } else if (hasNonSponsoredT || hasNonSponsoredO) {
          tagList.push({ text: "내돈내산", class: "bg-blue-100 text-blue-800" });
          tagTextsForFilter.push("내돈내산");
        } else if (hasSponsoredT) {
          tagList.push({ text: "정책 지킴 (텍스트)", class: "bg-green-100 text-green-800" });
          tagTextsForFilter.push("정책 지킴");
        } else if (hasSponsoredO) {
          tagList.push({ text: "정책 지킴 (이미지 OCR)", class: "bg-green-100 text-green-800" });
          tagTextsForFilter.push("정책 지킴");
        } else if (post.first_image_url?.includes("storep-phinf")) {
          tagList.push({ text: "불분명 (스티커)", class: "bg-gray-100 text-gray-700" });
          tagTextsForFilter.push("불분명");
        } else {
          tagList.push({ text: "불분명", class: "bg-gray-200 text-gray-800" });
          tagTextsForFilter.push("불분명");
        }

        // 카드 요소 생성
        const li = document.createElement("li");
        li.className = currentViewMode === 'grid'
          ? "border rounded-md p-2 bg-white shadow-sm flex flex-col text-sm min-h-[110px]"
          : "border rounded-md p-4 mb-4 bg-white shadow-sm";
        li.setAttribute("data-tags", tagTextsForFilter.join(" "));
        li.className += " min-w-0";


        const wrapper = document.createElement("div");
        wrapper.className = "flex flex-wrap gap-4 items-start";

        const imageWrapper = document.createElement("div");
        imageWrapper.className = "relative self-center";

        const img = document.createElement("img");
        img.src = finalImageUrl;
        img.alt = "썸네일";
        img.className = "w-20 h-20 sm:w-24 sm:h-24 object-contain bg-gray-100 border rounded-md";
        img.style.userSelect = "none";
        img.onerror = () => {
          img.style.display = "none";
          console.warn("이미지 로드 실패:", finalImageUrl);
        };
        // ✅ 클릭 시 모달 이미지 확대
        img.addEventListener("click", () => {
          const modal = document.getElementById("imageModal");
          const modalImg = document.getElementById("modalImage");
          modalImg.src = finalImageUrl;
          modal.classList.remove("hidden");
        });

        imageWrapper.appendChild(img);
        wrapper.appendChild(imageWrapper);

        const content = document.createElement("div");
        content.className = "flex-1 overflow-hidden min-w-0";

        const hasSponsoredInTitle = isSponsored(lowerTitle);
        const hasNonSponsoredInTitle = isNonSponsored(lowerTitle);

        const title = document.createElement("h2");
        title.className = "font-semibold text-sm leading-snug line-clamp-2 overflow-hidden";
        title.innerHTML = `<a href="${post.url}" target="_blank">${hasNonSponsoredInTitle
          ? highlightNonSponsoredKeywords(post.title)
          : hasSponsoredInTitle
            ? highlightSponsoredKeywords(post.title)
            : post.title
          }</a>`;


        const date = document.createElement("p");
        date.className = "text-sm text-gray-500 overflow-hidden text-ellipsis";
        date.textContent = post.date;

        content.appendChild(title);
        content.appendChild(date);

        if (currentViewMode === 'list') {
          const summary = document.createElement("p");
          summary.className = "text-xs text-gray-500 mt-1 overflow-hidden";
          summary.style.display = "-webkit-box";
          summary.style.webkitLineClamp = "2";
          summary.style.webkitBoxOrient = "vertical";
          summary.style.lineHeight = "1.2rem";
          summary.style.maxHeight = "2.4rem";
          summary.textContent = post.first_100_chars;

          //console.log("🟡 디버깅 시작 — 하이라이트 조건 체크");
          //console.log("📌 tagTextsForFilter:", tagTextsForFilter);
          //console.log("📌 tagList (텍스트 목록):", tagList.map(t => t.text));
          //console.log("📌 post.first_100_chars:", post.first_100_chars);

          const hasPolicyText = tagTextsForFilter.includes("정책 지킴") && tagList.some(t => t.text.includes("텍스트"));
          const hasNonSponText = tagTextsForFilter.includes("내돈내산");

          //console.log("✅ 정책 지킴 + 텍스트 조건:", hasPolicyText);
          //console.log("✅ 내돈내산 + 텍스트 조건:", hasNonSponText);

          if (hasPolicyText) {
            //console.log("🟢 하이라이트 적용: 정책 지킴 (텍스트)");
            summary.innerHTML = highlightSponsoredKeywords(post.first_100_chars);
          } else if (hasNonSponText) {
            //console.log("🔵 하이라이트 적용: 내돈내산 (텍스트)");
            summary.innerHTML = highlightNonSponsoredKeywords(post.first_100_chars);
          } else {
            //console.log("⚪ 하이라이트 없음: 기본 텍스트 출력");
            summary.textContent = post.first_100_chars;
          }

          content.appendChild(summary);
        }

        const tagContainer = document.createElement("div");
        tagContainer.className = "mt-auto pt-2 flex flex-wrap gap-1";
        tagList.forEach(tag => {
          const span = document.createElement("span");
          span.className = `text-xs px-2 py-0.5 rounded ${tag.class}`;
          span.textContent = tag.text;
          tagContainer.appendChild(span);
        });

        content.appendChild(tagContainer);
        wrapper.appendChild(content);
        li.appendChild(wrapper);
        list.appendChild(li);
      });
    }


    function renderTxt(posts) {
      // 최신 포스트 캐시
      window.latestPosts = posts;

      // 사용자 ID를 입력란에서 가져오기
      const blogId = (document.getElementById("blogId")?.value || "").trim() || "익명 사용자";
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10); // yyyy-mm-dd
      const timeStr = now.toTimeString().slice(0, 8); // HH:MM:SS

      const multiPageMode = document.getElementById("multiPageCheck")?.checked;
      const pageNum = parseInt(document.getElementById("pageNum")?.value || "1", 10);
      const totalPages = 20; // 고정되어 있으므로 상수로 지정


      const groups = {
        "🟢 정책 지킴 (공정위 이미지)": [],
        "🔴 정책 위반 (공정위 이미지)": [],
        "🟢 정책 지킴 (텍스트)": [],
        "🟢 정책 지킴 (이미지 OCR)": [],
        "🔵 내돈내산": [],
        "⚪ 불분명 (스티커)": [],
        "⚪ 불분명": []
      };

      // 그룹 분류
      posts.forEach(post => {
        const lowerTitle = (post.title || "").toLowerCase();
        const lowerText = (post.first_100_chars || "").toLowerCase();
        const lowerOcr = (post.first_ocr_text || "").toLowerCase();

        const hasSponsoredT = isSponsored(lowerText) || isSponsored(lowerTitle);
        const hasNonSponsoredT = isNonSponsored(lowerText) || isNonSponsored(lowerTitle);
        const hasSponsoredO = isSponsored(lowerOcr);
        const hasNonSponsoredO = isNonSponsored(lowerOcr);

        if (post.fair_trade_img_url) {
          if (post.fair_trade_img_position === 1) {
            groups["🟢 정책 지킴 (공정위 이미지)"].push(post);
          } else {
            groups["🔴 정책 위반 (공정위 이미지)"].push(post);
          }
        } else if (hasNonSponsoredT || hasNonSponsoredO) {
          groups["🔵 내돈내산"].push(post);
        } else if (hasSponsoredT) {
          groups["🟢 정책 지킴 (텍스트)"].push(post);
        } else if (hasSponsoredO) {
          groups["🟢 정책 지킴 (이미지 OCR)"].push(post);
        } else if (post.first_image_url?.includes("storep-phinf")) {
          groups["⚪ 불분명 (스티커)"].push(post);
        } else {
          groups["⚪ 불분명"].push(post);
        }
      });

      const showViolationOnly = document.getElementById("violationOnlyCheckbox")?.checked;
      const selectedDomain = document.getElementById("domainFilterSelect")?.value || "all";

      // tag 순서: 위반만 보기일 때는 🔴만, 아닐 때는 전체
      const tagOrder = showViolationOnly
        ? ["🔴 정책 위반 (공정위 이미지)"]
        : [
          "🟢 정책 지킴 (공정위 이미지)",
          "🔴 정책 위반 (공정위 이미지)",
          "🟢 정책 지킴 (텍스트)",
          "🟢 정책 지킴 (이미지 OCR)",
          "🔵 내돈내산",
          "⚪ 불분명 (스티커)",
          "⚪ 불분명"
        ];

      const pageLabel = multiPageMode
        ? `1~${pageNum} / ${totalPages}`
        : `${pageNum} / ${totalPages}`;

      let txt = `🔍 공정위 문구 검사기 - 페어블로그 (https://xpile98.github.io/FairBlog)\n\n`;
      txt += ` - 블로그 ID: ${blogId}\n`;
      txt += ` - 페이지: ${pageLabel}\n`;
      txt += ` - 검사일: ${dateStr} ${timeStr}\n\n`;
      txt += `📄 [공정위 표시 판단 요약 보고서]\n`;
      txt += ` - 총 ${posts.length}건 분석\n\n`;



      // 도메인 목록 수집 (드롭다운 반영용)
      const allDomains = new Set();

      // 본문 생성
      for (const tag of tagOrder) {
        const items = groups[tag];
        if (items.length === 0) continue;

        // 도메인 분류
        const domainMap = {};
        items.forEach(post => {
          const domain = getDomainAlias(post.fair_trade_img_url || post.first_image_url || "");
          allDomains.add(domain);
          if (!domainMap[domain]) domainMap[domain] = [];
          domainMap[domain].push(post);
        });

        // 도메인별 출력
        for (const [domain, domainPosts] of Object.entries(domainMap)) {
          if (selectedDomain !== "all" && domain !== selectedDomain) continue;

          txt += ` - ${tag} - ${domainPosts.length}건\n`;
          txt += `   -> 체험단 도메인: ${domain} (${domainPosts.length}건)\n`;
          txt += "───────────────────────\n";

          domainPosts.forEach((post, idx) => {
            txt += `${idx + 1}) ${post.title || "(제목 없음)"}\n`;
            txt += `   📎 링크: ${post.url}\n`;
            if (post.fair_trade_img_position)
              txt += `   🖼️ 위치: ${post.fair_trade_img_position}번째\n`;
            txt += `   📅 작성일: ${post.date || "알 수 없음"}\n\n`;
          });

          txt += "\n";
        }
      }

      // 보고서 출력
      lastGeneratedReport = txt;  // 전역 변수에 저장
      document.getElementById("reportContent").innerText = txt;

      // 드롭다운 업데이트
      const select = document.getElementById("domainFilterSelect");
      const existingOptions = Array.from(select.options).map(opt => opt.value);
      const newDomains = [...allDomains].filter(domain => !existingOptions.includes(domain));
      if (newDomains.length > 0) {
        // 전체만 남기고 초기화
        select.innerHTML = '<option value="all">전체</option>';
        [...allDomains].sort().forEach(domain => {
          const opt = document.createElement("option");
          opt.value = domain;
          opt.textContent = domain;
          select.appendChild(opt);
        });
        select.value = selectedDomain; // 유지
      }
    }

    let lastGeneratedReport = "";  // 전역에 보고서 원본 저장

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function copyToClipboard() {
      if (!lastGeneratedReport) {
        alert("❌ 복사할 보고서가 없습니다.");
        return;
      }

      navigator.clipboard.writeText(lastGeneratedReport).then(() => {
        alert("📋 보고서가 클립보드에 복사되었습니다!");
      }).catch(err => {
        alert("❌ 복사에 실패했습니다: " + err);
      });
    }


    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "전체" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }

    async function runOcrForPost(post) {
      let imageUrl = post.first_image_url;
      //console.log("runOcrForPost imageUrl: ", imageUrl);
      if (!imageUrl || !imageUrl.startsWith("http")) {
        post.first_ocr_text = "";
        return;
      }

      if (/w\d+_blur/.test(imageUrl)) {
        imageUrl = imageUrl.replace(/w\d+_blur/, "w800");
        //console.log("🔧 블러 제거된 이미지 주소로 교체:", imageUrl);
      } else {
        //console.log("🔧 이미지에 wXX_blur 없음:", imageUrl);
      }

      // ✅ 프록시 URL 구성
      const BASE_URL = location.hostname.includes("localhost") ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const proxyUrl = `${BASE_URL}/proxy?url=${encodeURIComponent(imageUrl)}`;
      //console.log(`🧩 OCR 대상 프록시 이미지: ${proxyUrl}`);


      const startTime = performance.now();

      try {
        //const { data: { text } } = await Tesseract.recognize(proxyUrl, 'kor', {
        //  logger: m => console.log(`[OCR] ${post.title}: ${m.status} (${Math.round(m.progress * 100)}%)`)
        //});
        const { data: { text } } = await Tesseract.recognize(proxyUrl, 'kor');


        const endTime = performance.now();
        const elapsed = (endTime - startTime).toFixed(1);

        post.first_ocr_text = text.replace(/\s+/g, "");
        //console.log(`✅ OCR 완료: ${post.title} (${elapsed}ms)`);
        //console.log(`🔍 OCR 결과:\n${post.first_ocr_text}\n`);
      } catch (err) {
        const failTime = performance.now();
        const elapsed = (failTime - startTime).toFixed(1);
        //console.error(`❌ OCR 실패: ${post.title} (${elapsed}ms)`, err);
        post.first_ocr_text = "";
      }
    }

    function setViewMode(mode) {
      currentViewMode = mode;
      //console.log("🔄 보기 모드 변경:", currentViewMode);
      const listEl = document.getElementById('postList');
      listEl.className = mode === 'grid'
        ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
        : 'space-y-4';

      const summaryEl = document.getElementById('summaryBox');

      if (mode === 'summary') {
        listEl.style.display = "none";
        summaryEl.style.display = "block";

        // ✅ 정렬 방식 '전체'로 고정 + 비활성화
        if (tagFilterSelect) {
          tagFilterSelect.value = "전체";
          tagFilterSelect.disabled = true;
        }
      } else {
        listEl.style.display = "grid";
        summaryEl.style.display = "none";

        if (tagFilterSelect) {
          tagFilterSelect.disabled = false;
        }

        listEl.className = mode === 'grid'
          ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
          : 'space-y-4';
      }

      // 🔁 다시 랜더링
      renderPosts(globalPostData);

      // ✅ 현재 태그 필터 반영
      const selectedTag = tagFilterSelect?.value || "전체";
      filterByTag(selectedTag);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    async function fetchBlogPosts() {
      let ocrQueue = [];
      let ocrCompleted = 0;

      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");
      const useDetailedCheck = document.getElementById("detailedCheck").checked;
      const multiPageMode = document.getElementById("multiPageCheck")?.checked;
      const startPage = multiPageMode ? 1 : pageNum;
      const endPage = pageNum;
      const totalPages = multiPageMode ? pageNum : 1;

      setProgressSplit(useDetailedCheck);

      if (!blogId) {
        alert("네이버 블로그 ID를 입력해주세요.");
        return;
      }

      if (multiPageMode) {
        alert(`📄 연속 분석 모드가 활성화되었습니다.\n\n1페이지부터 ${pageNum}페이지까지 순차 분석합니다.`);
      }

      startBtn.disabled = true;
      startBtn.classList.add("opacity-50", "cursor-not-allowed");

      const loadingText = document.getElementById("loadingText");
      const loadingBarFill = document.getElementById("loadingBar").firstElementChild;
      loadingText.textContent = "☁️ 서버를 준비 중입니다... (최대 20초 정도 소요될 수 있어요)";
      loadingBarFill.style.width = `0%`;
      document.getElementById("loadingText").classList.remove("hidden");
      document.getElementById("loadingBar").classList.remove("hidden");
      showLoading();

      const domainList = Object.keys(fairDomainAliasMap);
      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const analyzeSingleUrl = `${BASE_URL}/analyze_single`;
      const postListUrl = `${BASE_URL}/get_post_list`;

      try {
        const startTime = performance.now();
        let completed = 0;
        const allPosts = [];

        for (let page = startPage; page <= endPage; page++) {
          const res = await fetch(postListUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ blogId, pageNum: page })
          });

          if (!res.ok) throw new Error(`❌ ${page}페이지 글 목록 요청 실패`);

          const data = await res.json();
          const items = data.items || [];

          if (items.length === 0) {
            console.log(`📭 ${page}페이지 게시글 없음`);
            continue;
          }

          const urls = items.map(item =>
            `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`
          );

          const tasks = urls.map((postUrl, idx) => {
            const indexInAll = allPosts.length + idx;

            return fetch(analyzeSingleUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ postUrl, fairTradeImageLinks: domainList })
            })
              .then(r => r.ok ? r.json() : null)
              .catch(() => null)
              .then(result => {
                allPosts[indexInAll] = result;
                completed++;
                updateProgress(completed, totalPages * 24);
                loadingText.textContent = `⏳ ${completed} / ${totalPages * 24} 포스트 분석 중...`;

                // OCR 예약 조건만 확인해서 큐에 넣기
                if (
                  useDetailedCheck &&
                  result &&
                  !result.fair_trade_img_url &&
                  !result.first_ocr_text
                ) {
                  const lowerTitle = (result.title || "").toLowerCase();
                  const lowerText = (result.first_text_block || "").toLowerCase();
                  const imageUrl = result.first_image_url || "";
                  const isMapImage = imageUrl.includes("static.map/v2/map/staticmap.bin");

                  if (
                    !isMapImage &&
                    !isSponsored(lowerText) &&
                    !isSponsored(lowerTitle) &&
                    !isNonSponsored(lowerText) &&
                    !isNonSponsored(lowerTitle)
                  ) {
                    ocrQueue.push(result);
                  } else {
                    result.first_ocr_text = "";
                  }
                } else if (result) {
                  result.first_ocr_text = "";
                }
              });
          });

          await Promise.allSettled(tasks);
          await new Promise(resolve => setTimeout(resolve, 1200)); // 페이지 간 딜레이
        }

        // 🟡 OCR 단계 시작 (병렬 처리)
        const ocrTasks = ocrQueue.map((post, idx) =>
          runOcrForPost(post)
            .catch(err => {
              console.warn(`❌ OCR 실패: ${post.title}`, err);
            })
            .finally(() => {
              ocrCompleted++;
              updateOcrProgress(ocrCompleted, ocrQueue.length);
              loadingText.textContent = `📦 이미지 문구 분석 중... (${ocrCompleted} / ${ocrQueue.length})`;
            })
        );

        await Promise.allSettled(ocrTasks);

        const filtered = allPosts.filter(p => p);
        globalPostData = filtered;
        renderPosts(globalPostData);
        renderTxt(filtered);

        loadingText.textContent = `✅ 분석 완료! 총 ${filtered.length}건`;
        loadingBarFill.style.width = "100%";

        const endTime = performance.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        const avg = (elapsed / completed).toFixed(2);
        console.log(`⏱ 포스트당 평균 분석 시간: ${avg}초`);

      } catch (err) {
        console.error("❌ 분석 오류:", err);
        alert("⚠️ 네이버 블로그 분석 중 오류가 발생했습니다.");
      } finally {
        startBtn.disabled = false;
        startBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    }

  </script>


  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      deleteDoc,       // ✅ 이 줄 추가!
      doc              // ✅ 이 줄도 함께 필요 (문서 참조용)
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD2EEBetGbTQLhd7EUA21yYGHP0WOk5wIE",
      authDomain: "fairblog-e5054.firebaseapp.com",
      projectId: "fairblog-e5054",
      storageBucket: "fairblog-e5054.firebasestorage.app",
      messagingSenderId: "521579840672",
      appId: "1:521579840672:web:d00975b2bd5255639875c5",
      measurementId: "G-HNBS1KD7JX"
    };

    window.toggleGuestbook = function () {
      const guestbook = document.getElementById("guestbook");
      //console.log("토글 전:", guestbook.className);
      guestbook.classList.toggle("hidden");
      //console.log("토글 후:", guestbook.className);
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app)
    const db = getFirestore(app);
    const auth = getAuth();

    let isAdmin = false;

    document.getElementById("loginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.toggle("hidden");
    };

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("✅ 로그인 성공");
        document.getElementById("loginFormBox").classList.add("hidden");
      } catch (err) {
        alert("❌ 로그인 실패: " + err.message);
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("loginFormBox").classList.add("hidden");
      }
    });

    document.getElementById("closeLoginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.add("hidden");
    };

    // 로그아웃 처리
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("🚪 로그아웃 되었습니다");
    };

    // ✅ Auth 상태 감지 → startGuestbookListener 호출
    onAuthStateChanged(auth, async (user) => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (!loginBtn || !logoutBtn) {
        console.warn("❗ loginBtn 또는 logoutBtn 요소를 찾지 못했습니다.");
        return;
      }

      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        //console.log("✅ 로그인됨:", user.email);
        //console.log("🛡 isAdmin:", isAdmin);

        // ✅ 로그인 시 로그인 버튼 숨김, 로그아웃 버튼 표시
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

      } else {
        isAdmin = false;

        // ✅ 로그아웃 시 로그인 버튼 표시, 로그아웃 버튼 숨김
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }

      const nicknameInput = document.getElementById("nickname");
      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        if (isAdmin) {
          nicknameInput.value = "관리자";
          nicknameInput.disabled = true;
        } else {
          nicknameInput.disabled = false;
        }
      } else {
        isAdmin = false;
        nicknameInput.disabled = false;
      }

      startGuestbookListener(); // ← 여기서 UI 다시 렌더
    });

    // ✅ 이 부분이 실시간 방명록 리스너 정의
    function startGuestbookListener() {
      const q = query(
        collection(db, "guestbook"),
        orderBy("timestamp", "asc"),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        const list = document.getElementById("guestbookList");
        list.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");



          // ✅ 관리자 닉네임 스타일링
          const isAdminMessage = data.nickname === "관리자";

          const timestamp = data.timestamp?.toDate?.();
          const dateText = timestamp
            ? timestamp.toLocaleString('ko-KR', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
            : '작성일자 없음';

          li.className = "border-b py-2 text-sm text-left";

          li.innerHTML = `
            <div class="text-sm text-gray-800 break-words leading-snug">
              <span class="${isAdminMessage ? 'text-blue-600 font-bold' : 'font-medium'}">
                🧑 ${data.nickname}:
              </span>
              <span>${data.message}</span>
            </div>
            <div class="text-xs text-gray-500 mt-0.5 text-right w-full">
              🕒 ${dateText}
            </div>
          `;

          // ✅ 삭제 버튼은 현재 로그인한 사용자가 관리자일 때만
          if (isAdmin) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "삭제";
            delBtn.className = "text-xs text-red-500 hover:underline ml-2";
            delBtn.onclick = async () => {
              if (confirm("정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "guestbook", docSnap.id));
              }
            };
            li.appendChild(delBtn);
          }

          list.appendChild(li);
        });

        // ✅ 가장 마지막 메시지로 스크롤
        list.scrollTop = list.scrollHeight;
      });
    }

    function generateRandomNickname() {
      const adjectives = ["귀여운", "느긋한", "활발한", "용감한", "우아한", "빠른", "조용한", "엉뚱한"];
      const animals = ["토끼", "고양이", "강아지", "판다", "수달", "여우", "하마", "다람쥐"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      return `${adj} ${animal}`;
    }

    // ✅ 방명록 작성 처리
    const form = document.getElementById("guestbookForm");
    const nicknameInput = document.getElementById("nickname");
    const messageInput = document.getElementById("message");
    const list = document.getElementById("guestbookList");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let nickname = nicknameInput.value.trim();
      const message = messageInput.value.trim();
      if (!message) return;

      // ✅ 관리자일 경우 닉네임은 고정
      if (isAdmin) {
        nickname = "관리자";
      }

      // ✅ 일반 사용자는 "관리자" 닉네임 금지
      if (nickname === "관리자" && !isAdmin) {
        alert("❌ '관리자'라는 닉네임은 사용할 수 없습니다.");
        return;
      }

      // ✅ 비어 있거나 자동 입력 시 랜덤 생성
      if (!nickname) {
        nickname = generateRandomNickname();
      }

      try {
        await addDoc(collection(db, "guestbook"), {
          nickname,
          message,
          timestamp: serverTimestamp()
        });
        messageInput.value = "";
      } catch (err) {
        console.error("🔥 방명록 저장 실패:", err);
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const nicknameInput = document.getElementById("nickname");
      if (!nicknameInput.value) {
        nicknameInput.value = generateRandomNickname();  // ✅ 실제 입력값으로 설정
      }

      const guestbook = document.getElementById("guestbook");
      if (window.innerWidth < 640) {
        guestbook.classList.add("hidden");
      } else {
        guestbook.classList.remove("hidden");
      }

      setViewMode('list'); // 보기 모드 초기화 (리스트로)

    });

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('imageModal').classList.add('hidden');
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const check = document.getElementById("detailedCheck");

      check.addEventListener("change", () => {
        if (check.checked) {
          alert(
            "✅ 이미지 문구 분석이 활성화되었습니다.\n\n" +
            "공정위 도메인 이미지가 없는 경우,\n대표 이미지(첫 번째 이미지) 속 문구까지 자동으로 검사합니다.\n\n" +
            "텍스트에 명시되지 않은 스티커(예: '제공받음')가 포함된 경우에도 일부 감지할 수 있습니다.\n\n" +
            "단, 이미지의 글자가 너무 작거나 특이한 글꼴인 경우\n정확한 인식이 어려울 수 있습니다."
          );
        } else {
          alert(
            "ℹ️ 이미지 문구 분석이 비활성화되었습니다.\n\n" +
            "공정위 도메인 이미지와 텍스트만 분석합니다."
          );
        }
      });
    });


  </script>
</body>

</html>
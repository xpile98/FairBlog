<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="qoyiCn5HdEafxTpuvuTjg9UAPNcl__rm0N85A-RChtU" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>공정위 문구 검사기</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YRHK2QVDMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YRHK2QVDMT');
  </script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">📝 공정위 문구 검사기</h1>
    
    <!-- 블로그 ID 입력 -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">블로그 ID 입력:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 min-w-[120px] px-3 py-2 border rounded text-sm" placeholder="예: blogpeople" />
        <div class="flex items-center gap-1 text-sm">
          <label for="pageNum" class="text-gray-600"> </label>

          <select id="pageNum" class="border rounded px-2 py-1 text-sm">
            <option value="1" selected>1페이지</option>
            <option value="2">2페이지</option>
            <option value="3">3페이지</option>
            <option value="4">4페이지</option>
            <option value="5">5페이지</option>
            <option value="6">6페이지</option>
            <option value="7">7페이지</option>
            <option value="8">8페이지</option>
            <option value="9">9페이지</option>
            <option value="10">10페이지</option>
          </select>

          <span class="text-gray-600">  </span>
          <!-- ✅ 선택 결과 안내 -->
        </div>
        <button id="startBtn" onclick="fetchBlogPosts()" class="bg-blue-600 text-white px-4 py-2 rounded whitespace-nowrap hover:bg-blue-700 transition text-sm">검사 시작</button>
      </div>
    </div>

    <div id="loadingText" class="mt-2 text-sm text-blue-700 hidden">분석 대기 중...</div>
    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 mb-6 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <!-- 정렬 방식 -->
    <div class="mb-2 text-sm font-semibold text-gray-700">🧭 정렬 방식</div>
    <div id="tagFilter" class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="filterByTag('전체')" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">전체</button>
      <button onclick="filterByTag('공정위O')" class="px-3 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200">공정위O</button>
      <button onclick="filterByTag('공정위X')" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">공정위X</button>
      <button onclick="filterByTag('상단')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">상단</button>
      <button onclick="filterByTag('하단')" class="px-3 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200">하단</button>
      <button onclick="filterByTag('스티커')" class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200">스티커</button>
    </div>

    <!-- 보기 방식 -->
    <div class="mb-2 text-sm font-semibold text-gray-700">🖼 보기 방식</div>
    <div class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="setViewMode('list')" id="btnListView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">☰ 리스트</button>
      <button onclick="setViewMode('grid')" id="btnGridView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">🔲 그리드</button>
      <button onclick="setViewMode('summary')" id="btnSummaryView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">📄 요약</button>
    </div>

    <!-- 결과 표시: 요약 보기 모드에서만 표시 -->
    <section id="summaryBox" class="mt-8 hidden">
      <h2 class="text-lg font-semibold mb-2">📄 요약 보기</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT 다운로드</button>
    </section>

    
    <!-- 결과 표시 -->
    <ul id="postList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
      <!-- 초기 안내 메시지 -->
      <li id="emptyMessage" class="col-span-full text-center text-gray-500 py-10">
        🔍 블로그 ID를 입력하고 [검사 시작]을 누르면 이곳에 결과가 표시됩니다.
      </li>
    </ul>

    <!-- 공정위 도메인 관리 -->
    <section class="mt-8 mb-6">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">⚙️ 공정위 이미지 도메인 목록</h2>
      <div class="bg-gray-50 border rounded px-4 py-3">
        <ul id="fairLinkList" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-700 list-none p-0 m-0"></ul>
      </div>
    </section>

    <!-- 테스트/운영 모드 상태 표시 -->
    <div id="buildModeLabel" class="fixed bottom-2 left-2 text-xs text-white bg-gray-500 px-2 py-1 rounded opacity-70 z-50">
      모드 표시 중...
    </div>
    
    <!-- 우측 상단 고정 로그인/로그아웃 버튼 -->
    <div id="adminAuth" class="fixed top-2 right-2 z-50 space-x-2">
      <button id="loginBtn" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">🔐 로그인</button>
      <button id="logoutBtn" class="hidden text-xs bg-gray-600 text-white px-2 py-1 rounded">🚪 로그아웃</button>
    </div>

    <!-- 이미지 모달 뷰어 -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
      <img id="modalImage" src="" alt="확대 이미지" class="max-w-[90vw] max-h-[90vh] rounded shadow-lg border bg-white" />
    </div>


    <!-- 토글 버튼 -->
    <button onclick="toggleGuestbook()"
      class="fixed bottom-4 right-4 z-50 bg-blue-600 text-white px-3 py-2 rounded">
      💬 방명록
    </button>

    <!-- ✅ 모바일: hidden, PC: block -->
    <div id="guestbook" class="hidden fixed top-20 right-4 w-72 bg-white border rounded shadow-lg p-4 z-50 text-sm" style="top: 150px;">
      <h3 class="text-lg font-bold mb-2">📓 방명록</h3>
      <form id="guestbookForm" class="mb-2">
        <input id="nickname" type="text" placeholder="닉네임" class="w-full mb-1 px-2 py-1 border rounded" />
        <textarea id="message" placeholder="한 줄 메시지" class="w-full px-2 py-1 border rounded"></textarea>
        <button type="submit" class="mt-2 w-full bg-blue-600 text-white px-2 py-1 rounded">작성</button>
      </form>
      <ul id="guestbookList" class="space-y-1 max-h-48 overflow-auto text-xs text-gray-700"></ul>
    </div>
    
    <!-- 로그인 모달 -->
    <div id="loginFormBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white border rounded shadow-lg p-6 w-80 relative">
        <!-- ✅ 닫기 버튼 -->
        <button id="closeLoginBtn"
          class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl font-bold">&times;</button>

        <h3 class="text-lg font-semibold mb-4 text-center">🔐 관리자 로그인</h3>
        <form id="loginForm" class="space-y-3">
          <input id="loginEmail" type="email" placeholder="이메일" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <input id="loginPassword" type="password" placeholder="비밀번호" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <button type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">로그인</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const isTestMode = location.origin.includes("127.0.0.1") || location.origin.includes("localhost");

    const modeLabel = document.getElementById("buildModeLabel");
    if (isTestMode) {
      modeLabel.textContent = "🧪 테스트 모드 (로컬)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-yellow-600");
    } else {
      modeLabel.textContent = "✅ 최종 빌드 (20250514_1340)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-green-700");
    }

    const fairDomainAliasMap = {
      "강남맛집.net": "강남맛집",        
      "xn--939au0g4vj8sq.net": "강남맛집",        
      "blogmall.net": "미블",        
      "d3i7y4ugnppb9p.cloudfront.net": "슈퍼멤버스",        
      "www.reviewnote.co.kr": "리뷰노트",        
      "dinnerqueen.net": "디너의여왕",        
      "revu.net": "레뷰",        
      "reviewplace.co.kr": "리뷰플레이스",       
      "nugunablog.co.kr": "클라우드리뷰",  
      "tble.kr": "티블",  
      "seoulouba.co.kr": "서울오빠",  
      "dailyview.kr": "데일리뷰",  
      "assaview.co.kr": "아싸뷰",     
      "ringble.co.kr": "링블",       
      "blogdexreview.space": "블덱스",    
      "chvu_01.jpg": "체험뷰",    
      "chvu_02.jpg": "체험뷰",    
      "chvu_03.jpg": "체험뷰",    
      "cometoplay.kr": "놀러와",    
      "가보자체험단.com": "가보자",    
      "xn--o39a04kpnjo4k9hgflp.com": "가보자",    
      "sioneview.com": "시원뷰",    
      "kormedia.co.kr": "오마이블로그",    
      "블로그원정대.com": "블로그원정대",    
      "xn--2i0bl9gt7ekxgr7lzzb.com": "블로그원정대",    
      "모두모여체험단.com": "모두모여",    
      "xn--6j1br0ag3lba435lvsj96p.com": "모두모여",    
      "unnispick.com": "언니스픽",    
      "mateb.kr": "기타체험단"          
    };

    function getDomainAlias(imageUrl) {
      for (const domain in fairDomainAliasMap) {
        if (imageUrl.includes(domain)) {
          return fairDomainAliasMap[domain];
        }
      }
      return "기타/알 수 없음";
    }

    //function renderFairLinks() {
    //  const list = document.getElementById("fairLinkList");
    //  list.innerHTML = "";
    //
    //  Object.entries(fairDomainAliasMap).forEach(([domain, name], idx) => {
    //    const li = document.createElement("li");
    //    li.innerHTML = `${idx + 1}. <strong>${name}</strong> <span class="text-gray-500 text-sm">(${domain})</span>`;
    //    list.appendChild(li);
    //  });
    //}

    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";

      const basePath = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');

      const seenNames = new Set();  // 중복 제거용

      Object.entries(fairDomainAliasMap).forEach(([domain, name]) => {
        if (seenNames.has(name)) return;  // 중복된 이름은 건너뜀
        seenNames.add(name);

        const a = document.createElement("a");
        a.href = `http://${domain}`;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "inline-block box-border p-[5px_8px_6px] border border-gray-200 rounded-[6px] text-center w-20 h-10 flex items-center justify-center text-xs font-semibold text-gray-600";

        a.onclick = (e) => e.preventDefault();  // ✅ 링크 클릭 방지

        const img = new Image();
        img.src = `${basePath}/img/${name}.png`;
        img.alt = name;
        img.className = "w-full h-full object-contain";

        img.onload = () => {
          a.textContent = "";
          a.appendChild(img);
        };

        img.onerror = () => {
          a.textContent = name;
        };

        list.appendChild(a);
      });
    }


    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingText").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
      document.getElementById("loadingText").classList.add("hidden");
    }

    // 초기 렌더
    renderFairLinks();

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    // 포스트 렌더링
    function renderPosts(posts) {
    const list = document.getElementById("postList");
    list.innerHTML = "";

    const emptyMsg = document.getElementById("emptyMessage");
    if (emptyMsg) emptyMsg.remove();

    posts.forEach(post => {
      const hasFair = post.fair_trade_img_url;
      const useFairImage = hasFair && post.fair_trade_img_position === 1;
      const hasSticker = post.first_image_url?.includes("storep-phinf");

      // ✅ 우선순위: 공정위 상단 이미지 > 스티커 이미지 > 일반 썸네일
      let imageSrc = useFairImage
        ? post.fair_trade_img_url
        : hasSticker
          ? post.first_image_url
          : post.first_image_url;

      if (imageSrc.includes("강남맛집.net")) {
        imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
      }

      if (!useFairImage && imageSrc.includes("type=w") && imageSrc.includes("_blur")) {
        imageSrc = imageSrc.replace(/type=w\d+_blur/, 'type=w800');
      }

      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const encodedUrl = encodeURIComponent(imageSrc);
      const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
      const finalImageUrl = useFairImage ? imageSrc : proxyImageSrc;

      // 태그 정리
      const tagList = [];
      const tagTextsForFilter = [];

      if (hasFair) {
        tagList.push({ text: "공정위O", class: "bg-green-100 text-green-800" });
        tagTextsForFilter.push("공정위O");

        if (post.fair_trade_img_position === 1) {
          tagList.push({ text: "상단", class: "bg-blue-100 text-blue-800" });
          tagTextsForFilter.push("상단");
        } else {
          tagList.push({ text: "하단", class: "bg-red-100 text-red-800" });
          tagTextsForFilter.push("하단");
        }
      } else {
        tagList.push({ text: "공정위X", class: "bg-gray-200 text-gray-800" });
        tagTextsForFilter.push("공정위X");
      }

      if (post.first_image_url?.includes("storep-phinf")) {
        tagList.push({ text: "스티커", class: "bg-yellow-100 text-yellow-800" });
        tagTextsForFilter.push("스티커");
      }

      // 카드 요소 생성
      const li = document.createElement("li");
      li.className = currentViewMode === 'grid'
        ? "border rounded-md p-2 bg-white shadow-sm flex flex-col text-sm min-h-[180px]"
        : "border rounded-md p-4 mb-4 bg-white shadow-sm";
      li.setAttribute("data-tags", tagTextsForFilter.join(" "));

      const wrapper = document.createElement("div");
      wrapper.className = "flex gap-4 items-start";

      const imageWrapper = document.createElement("div");
      imageWrapper.className = "relative";

      const img = document.createElement("img");
      img.src = finalImageUrl;
      img.alt = "썸네일";
      img.className = useFairImage
        ? "w-24 h-24 sm:w-32 sm:h-32 object-contain bg-gray-100 border rounded-md"
        : "w-24 h-24 sm:w-32 sm:h-32 object-cover bg-gray-100 border rounded-md";
      img.style.userSelect = "none";
      img.onerror = () => { img.style.display = "none"; };

      // ✅ 클릭 시 모달 이미지 확대
      img.addEventListener("click", () => {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        modalImg.src = finalImageUrl;
        modal.classList.remove("hidden");
      });

      imageWrapper.appendChild(img);
      wrapper.appendChild(imageWrapper);

      const content = document.createElement("div");
      content.className = "flex-1 overflow-hidden";

      const title = document.createElement("h2");
      title.className = "font-semibold text-sm leading-snug line-clamp-2 overflow-hidden";
      title.innerHTML = `<a href="${post.url}" target="_blank">${post.title}</a>`;

      const date = document.createElement("p");
      date.className = "text-sm text-gray-500";
      date.textContent = post.date;

      content.appendChild(title);
      content.appendChild(date);

      if (!hasFair) {
        const summary = document.createElement("p");
        summary.className = "text-xs text-gray-500 mt-1 overflow-hidden";
        summary.style.display = "-webkit-box";
        summary.style.webkitLineClamp = "2";
        summary.style.webkitBoxOrient = "vertical";
        summary.style.lineHeight = "1.2rem";
        summary.style.maxHeight = "2.4rem";
        summary.textContent = post.first_100_chars;
        content.appendChild(summary);
      }

      const tagContainer = document.createElement("div");
      tagContainer.className = "mt-auto pt-2 flex flex-wrap gap-1";
      tagList.forEach(tag => {
        const span = document.createElement("span");
        span.className = `text-xs px-2 py-0.5 rounded ${tag.class}`;
        span.textContent = tag.text;
        tagContainer.appendChild(span);
      });

      content.appendChild(tagContainer);
      wrapper.appendChild(content);
      li.appendChild(wrapper);
      list.appendChild(li);
    });
  }


    function renderTxt(posts) {
      const suspiciousPosts = posts.filter(p =>
        p.fair_trade_img_url && p.fair_trade_img_position !== 1
      );

      // 도메인 그룹화
      const grouped = {};

      suspiciousPosts.forEach(post => {
        const domainAlias = getDomainAlias(post.fair_trade_img_url);
        if (!grouped[domainAlias]) grouped[domainAlias] = [];
        grouped[domainAlias].push(post);
      });

      let txt = "📌 [공정위 문구 있음 + 첫 번째 아님 → 의심 게시글]\n";
      txt += `총 ${suspiciousPosts.length}건\n`;
      txt += "────────────────────────────\n\n";

      for (const domainAlias of Object.keys(grouped)) {
        txt += `🔸 ${domainAlias}\n`;
        txt += "────────────────\n";

        grouped[domainAlias].forEach((p, idx) => {
          txt += `${idx + 1}) ${p.title || "(제목 없음)"}\n`;
          txt += `   📎 링크: ${p.url}\n`;
          txt += `   🖼️ 위치: ${p.fair_trade_img_position}번째\n\n`;
        });
      }

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "전체" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }

    let currentViewMode = 'list';

    function setViewMode(mode) {
      currentViewMode = mode;
      const listEl = document.getElementById('postList');
      const summaryEl = document.getElementById('summaryBox');

      if (mode === 'summary') {
        listEl.style.display = "none";
        summaryEl.style.display = "block";
      } else {
        listEl.style.display = "grid";
        summaryEl.style.display = "none";

        listEl.className = mode === 'grid'
          ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
          : 'space-y-4';
      }

      // 버튼 강조 스타일
      ['btnListView', 'btnGridView', 'btnSummaryView'].forEach(id => {
        document.getElementById(id).classList.remove("bg-blue-600", "text-white");
      });
      const activeBtn = document.getElementById(`btn${capitalize(mode)}View`);
      activeBtn.classList.add("bg-blue-600", "text-white");
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }



    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");

      if (!blogId) {
        alert("블로그 ID를 입력해주세요.");
        return;
      }
      
      // 👉 버튼 비활성화
      startBtn.disabled = true;
      startBtn.classList.add("opacity-50", "cursor-not-allowed");

      showLoading();
      const loadingText = document.getElementById("loadingText");
      const domainList = Object.keys(fairDomainAliasMap);
      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const analyzeSingleUrl = `${BASE_URL}/analyze_single`;
      const postListUrl = `${BASE_URL}/get_post_list`;

      try {
        // ⏱ 전체 시간 측정 시작
        const startTime = performance.now();

        // 📥 1단계: 서버에서 포스트 리스트 받아오기
        loadingText.textContent = "📥 블로그 글 목록 불러오는 중...";
        const res = await fetch(postListUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogId, pageNum })
        });

        if (!res.ok) throw new Error("네이버 블로그 목록 요청 실패");
        const data = await res.json();
        const items = data.items || [];

        if (items.length === 0) {
          alert("📭 게시글이 없습니다.");
          return;
        }

        const urls = items.map(item =>
          `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`
        );

        // 🔁 2단계: 병렬 분석 (n개씩)
        const allPosts = new Array(urls.length); // 결과 저장용 (정렬 유지)
        const batchSize = 8;
        let completed = 0;

        for (let i = 0; i < urls.length; i += batchSize) {
          const batch = urls.slice(i, i + batchSize);

          const tasks = batch.map((postUrl, idx) => {
            const realIdx = i + idx; // 전체 인덱스
            return fetch(analyzeSingleUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                postUrl,
                fairTradeImageLinks: domainList
              })
            })
              .then(r => r.ok ? r.json() : null)
              .catch(() => null)
              .then(result => {
                allPosts[realIdx] = result; // ✅ 순서에 맞춰 저장
                completed++;
                updateProgress(completed, urls.length);
                loadingText.textContent = `⏳ ${completed} / ${urls.length} 포스트 분석 중...`;
              });
          });

          await Promise.allSettled(tasks);
        }

        // 🟢 3단계: 결과 렌더링
        const filteredPosts = allPosts.filter(p => p !== null);
        renderPosts(filteredPosts);
        //renderPosts(allPosts);
        renderTxt(allPosts);
        loadingText.textContent = `✅ 분석 완료! 총 ${allPosts.length}건`;

        // ⏱ 소요 시간 로그 출력
        const endTime = performance.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        const avg = (elapsed / completed).toFixed(2);
        console.log(`✅ 전체 분석 시간: ${elapsed}초`);
        console.log(`⏱ 포스트당 평균 분석 시간: ${avg}초`);

      } catch (err) {
        console.error("분석 오류:", err);
        alert("⚠️ 블로그 분석 중 오류가 발생했습니다.");
      } finally {
        
        // 👉 버튼 다시 활성화
        startBtn.disabled = false;
        startBtn.classList.remove("opacity-50", "cursor-not-allowed");

        hideLoading();
      }
    }
  </script>
  

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      deleteDoc,       // ✅ 이 줄 추가!
      doc              // ✅ 이 줄도 함께 필요 (문서 참조용)
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD2EEBetGbTQLhd7EUA21yYGHP0WOk5wIE",
      authDomain: "fairblog-e5054.firebaseapp.com",
      projectId: "fairblog-e5054",
      storageBucket: "fairblog-e5054.firebasestorage.app",
      messagingSenderId: "521579840672",
      appId: "1:521579840672:web:d00975b2bd5255639875c5",
      measurementId: "G-HNBS1KD7JX"
    };

    window.toggleGuestbook = function () {
      const guestbook = document.getElementById("guestbook");
      console.log("토글 전:", guestbook.className);
      guestbook.classList.toggle("hidden");
      console.log("토글 후:", guestbook.className);
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app)
    const db = getFirestore(app);
    const auth = getAuth();

    let isAdmin = false;

    document.getElementById("loginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.toggle("hidden");
    };

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("✅ 로그인 성공");
        document.getElementById("loginFormBox").classList.add("hidden");
      } catch (err) {
        alert("❌ 로그인 실패: " + err.message);
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("loginFormBox").classList.add("hidden");
      }
    });

    document.getElementById("closeLoginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.add("hidden");
    };
    
    // 로그아웃 처리
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("🚪 로그아웃 되었습니다");
    };

    // ✅ Auth 상태 감지 → startGuestbookListener 호출
    onAuthStateChanged(auth, async (user) => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (!loginBtn || !logoutBtn) {
        console.warn("❗ loginBtn 또는 logoutBtn 요소를 찾지 못했습니다.");
        return;
      }

      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        //console.log("✅ 로그인됨:", user.email);
        //console.log("🛡 isAdmin:", isAdmin);

        // ✅ 로그인 시 로그인 버튼 숨김, 로그아웃 버튼 표시
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

      } else {
        isAdmin = false;

        // ✅ 로그아웃 시 로그인 버튼 표시, 로그아웃 버튼 숨김
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }

      const nicknameInput = document.getElementById("nickname");
      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        if (isAdmin) {
          nicknameInput.value = "관리자";
          nicknameInput.disabled = true;
        } else {
          nicknameInput.disabled = false;
        }
      } else {
        isAdmin = false;
        nicknameInput.disabled = false;
      }

      startGuestbookListener(); // ← 여기서 UI 다시 렌더
    });

    // ✅ 이 부분이 실시간 방명록 리스너 정의
    function startGuestbookListener() {
      const q = query(
        collection(db, "guestbook"),
        orderBy("timestamp", "asc"),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        const list = document.getElementById("guestbookList");
        list.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");

          // ✅ 기본 스타일
          //li.className = "flex justify-between items-center border-b py-1";
          li.className = "flex flex-col justify-between h-full min-h-[200px] border rounded-md p-2 bg-white shadow-sm text-sm";


          // ✅ 관리자 닉네임 스타일링
          const isAdminMessage = data.nickname === "관리자";

          li.innerHTML = `
            <span class="${isAdminMessage ? 'text-blue-600 font-bold' : ''}">
              🗣 ${data.nickname}: ${data.message}
            </span>
          `;

          // ✅ 삭제 버튼은 현재 로그인한 사용자가 관리자일 때만
          if (isAdmin) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "삭제";
            delBtn.className = "text-xs text-red-500 hover:underline ml-2";
            delBtn.onclick = async () => {
              if (confirm("정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "guestbook", docSnap.id));
              }
            };
            li.appendChild(delBtn);
          }

          list.appendChild(li);
        });
      });
    }

    function generateRandomNickname() {
      const adjectives = ["귀여운", "느긋한", "활발한", "용감한", "우아한", "빠른", "조용한", "엉뚱한"];
      const animals = ["토끼", "고양이", "강아지", "판다", "수달", "여우", "하마", "다람쥐"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      return `${adj} ${animal}`;
    }
    
    // ✅ 방명록 작성 처리
    const form = document.getElementById("guestbookForm");
    const nicknameInput = document.getElementById("nickname");
    const messageInput = document.getElementById("message");
    const list = document.getElementById("guestbookList");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let nickname = nicknameInput.value.trim();
      const message = messageInput.value.trim();
      if (!message) return;

      // ✅ 관리자일 경우 닉네임은 고정
      if (isAdmin) {
        nickname = "관리자";
      }

      // ✅ 일반 사용자는 "관리자" 닉네임 금지
      if (nickname === "관리자" && !isAdmin) {
        alert("❌ '관리자'라는 닉네임은 사용할 수 없습니다.");
        return;
      }

      // ✅ 비어 있거나 자동 입력 시 랜덤 생성
      if (!nickname) {
        nickname = generateRandomNickname();
      }

      try {
        await addDoc(collection(db, "guestbook"), {
          nickname,
          message,
          timestamp: serverTimestamp()
        });
        messageInput.value = "";
      } catch (err) {
        console.error("🔥 방명록 저장 실패:", err);
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const nicknameInput = document.getElementById("nickname");
      if (!nicknameInput.value) {
        nicknameInput.value = generateRandomNickname();  // ✅ 실제 입력값으로 설정
      }

      const guestbook = document.getElementById("guestbook");
      if (window.innerWidth < 640) {
        guestbook.classList.add("hidden");
      } else {
        guestbook.classList.remove("hidden");
      }
    });

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('imageModal').classList.add('hidden');
      }
    });

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³µì •ìœ„ ë¸”ë¡œê·¸ ê²€ì‚¬ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬ê¸°</h1>
    
    <!-- ë¸”ë¡œê·¸ ID ì…ë ¥ -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">ë¸”ë¡œê·¸ ID ì…ë ¥:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 border rounded px-3 py-2" placeholder="ì˜ˆ: blogpeople" />
        <div class="flex items-center gap-1 text-sm">
          <label for="pageNum" class="text-gray-600"> </label>

          <select id="pageNum" class="border rounded px-2 py-1 text-sm">
            <option value="1" selected>1í˜ì´ì§€</option>
            <option value="2">2í˜ì´ì§€</option>
            <option value="3">3í˜ì´ì§€</option>
            <option value="4">4í˜ì´ì§€</option>
            <option value="5">5í˜ì´ì§€</option>
            <option value="6">6í˜ì´ì§€</option>
            <option value="7">7í˜ì´ì§€</option>
            <option value="8">8í˜ì´ì§€</option>
            <option value="9">9í˜ì´ì§€</option>
            <option value="10">10í˜ì´ì§€</option>
          </select>

          <span class="text-gray-600">íƒìƒ‰</span>
          <!-- âœ… ì„ íƒ ê²°ê³¼ ì•ˆë‚´ -->
        </div>
        <button onclick="fetchBlogPosts()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">ê²€ì‚¬ ì‹œì‘</button>
      </div>
    </div>

    <div id="loadingText" class="mt-2 text-sm text-blue-700 hidden">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 mb-6 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <div id="tagFilter" class="mt-6 mb-4 flex flex-wrap gap-2">
      <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 bg-gray-300 rounded">ì „ì²´</button>
      <button onclick="filterByTag('ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ')" class="px-3 py-1 bg-gray-300 rounded">ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ</button>
      <button onclick="filterByTag('ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ')" class="px-3 py-1 bg-gray-300 rounded">ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ</button>
      <button onclick="filterByTag('ìƒë‹¨ ë°°ì¹˜')" class="px-3 py-1 bg-gray-300 rounded">ìƒë‹¨ ë°°ì¹˜</button>
      <button onclick="filterByTag('í•˜ë‹¨ ë°°ì¹˜')" class="px-3 py-1 bg-gray-300 rounded">í•˜ë‹¨ ë°°ì¹˜</button>
      <button onclick="filterByTag('ìŠ¤í‹°ì»¤ ìˆìŒ')" class="px-3 py-1 bg-gray-300 rounded">ìŠ¤í‹°ì»¤ ìˆìŒ</button>
      <button onclick="filterByTag('ìŠ¤í‹°ì»¤ ì—†ìŒ')" class="px-3 py-1 bg-gray-300 rounded">ìŠ¤í‹°ì»¤ ì—†ìŒ</button>
    </div>


    <!-- ê²°ê³¼ í‘œì‹œ -->
    <ul id="postList" class="space-y-4"></ul>
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">ğŸ“„ ì‹ ê³ ìš© ìš”ì•½ TXT</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT ë‹¤ìš´ë¡œë“œ</button>
    </section>

    <!-- ê³µì •ìœ„ ë„ë©”ì¸ ê´€ë¦¬ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">âš™ï¸ ê³µì •ìœ„ ì´ë¯¸ì§€ ë„ë©”ì¸ ëª©ë¡</h2>
      <ul id="fairLinkList" class="text-sm text-gray-700 space-y-1 pl-1 list-disc list-inside"></ul>
    </section>

    <!-- í…ŒìŠ¤íŠ¸/ìš´ì˜ ëª¨ë“œ ìƒíƒœ í‘œì‹œ -->
    <div id="buildModeLabel" class="fixed bottom-2 right-2 text-xs text-white bg-gray-500 px-2 py-1 rounded opacity-70 z-50">
      ëª¨ë“œ í‘œì‹œ ì¤‘...
    </div>
  </div>

  <script>
    const isTestMode = location.origin.includes("127.0.0.1") || location.origin.includes("localhost");

    const modeLabel = document.getElementById("buildModeLabel");
    if (isTestMode) {
      modeLabel.textContent = "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë¡œì»¬)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-yellow-600");
    } else {
      modeLabel.textContent = "âœ… ìµœì¢… ë¹Œë“œ (20250513_1650)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-green-700");
    }

    const fairDomainAliasMap = {
      "ê°•ë‚¨ë§›ì§‘.net": "ê°•ë‚¨ë§›ì§‘",        
      "xn--939au0g4vj8sq.net": "ê°•ë‚¨ë§›ì§‘",        
      "blogmall.net": "ë¯¸ë¸”",        
      "d3i7y4ugnppb9p.cloudfront.net": "ìŠˆí¼ë©¤ë²„ìŠ¤",        
      "www.reviewnote.co.kr": "ë¦¬ë·°ë…¸íŠ¸",        
      "dinnerqueen.net": "ë””ë„ˆì˜ì—¬ì™•",        
      "revu.net": "ë ˆë·°",        
      "reviewplace.co.kr": "ë¦¬ë·°í”Œë ˆì´ìŠ¤",       
      "postfiles.pstatic.net": "í´ë¼ìš°ë“œë¦¬ë·°",  
      "tble.kr": "í‹°ë¸”",  
      "seoulouba.co.kr": "ì„œìš¸ì˜¤ë¹ ",  
      "dailyview.kr": "ë°ì¼ë¦¬ë·°",  
      "assaview.co.kr": "ì•„ì‹¸ë·°",     
      "ringble.co.kr": "ë§ë¸”",     
      "unnispick.com": "ì–¸ë‹ˆìŠ¤í”½",     
      "blogdexreview.space": "ë¸”ë±ìŠ¤",     
      "mateb.kr": "ê¸°íƒ€ì²´í—˜ë‹¨"          
    };

    function getDomainAlias(imageUrl) {
      for (const domain in fairDomainAliasMap) {
        if (imageUrl.includes(domain)) {
          return fairDomainAliasMap[domain];
        }
      }
      return "ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ";
    }

    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";

      Object.entries(fairDomainAliasMap).forEach(([domain, name], idx) => {
        const li = document.createElement("li");
        li.innerHTML = `${idx + 1}. <strong>${name}</strong> <span class="text-gray-500 text-sm">(${domain})</span>`;
        list.appendChild(li);
      });
    }

    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingText").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
      document.getElementById("loadingText").classList.add("hidden");
    }

    // ì´ˆê¸° ë Œë”
    renderFairLinks();

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    // í¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderPosts(posts) {
      const list = document.getElementById("postList");
      list.innerHTML = "";

      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const isSuspicious = hasFair && post.fair_trade_img_position !== 1;
        const useFairImage = post.fair_trade_img_url && post.fair_trade_img_position === 1;
        let imageSrc = useFairImage ? post.fair_trade_img_url : post.first_image_url;
        
        // âœ… ê°•ë‚¨ë§›ì§‘.net í¬í•¨ ì‹œ ë¬´ì¡°ê±´ ê³ ì • URLë¡œ ëŒ€ì²´
        if (imageSrc.includes("ê°•ë‚¨ë§›ì§‘.net")) {
          imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
        }

        let BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
        const encodedUrl = encodeURIComponent(imageSrc);
        const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
        console.log("âœ… ìµœì¢… ìš”ì²­ URL:", encodedUrl);

        // íƒœê·¸ ë°•ìŠ¤ ëª©ë¡ ì¤€ë¹„
        const tagList = [];

        if (hasFair) {
          tagList.push({ text: "âœ… ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ", class: "text-green-700 bg-green-100" });

          if (post.fair_trade_img_position === 1) {
            tagList.push({ text: "ğŸ“Œ ìƒë‹¨ ë°°ì¹˜", class: "text-blue-700 bg-blue-100" });
          } else {
            tagList.push({ text: "â— í•˜ë‹¨ ë°°ì¹˜", class: "text-red-700 bg-red-100" });
          }
        } else {
          tagList.push({ text: "ğŸš« ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ", class: "text-gray-700 bg-gray-100" });
        }

        if (post.first_image_url?.includes("storep-phinf")) {
          tagList.push({ text: "ğŸ·ï¸ ìŠ¤í‹°ì»¤ ìˆìŒ", class: "text-yellow-700 bg-yellow-100" });
        } else {
          tagList.push({ text: "ìŠ¤í‹°ì»¤ ì—†ìŒ", class: "text-gray-500 bg-gray-100" });
        }

        // DOMìœ¼ë¡œ ê°ê°ì˜ span ìš”ì†Œ ìƒì„±í•´ì„œ pì— ë¶™ì´ê¸°
        const tagContainer = document.createElement("p");
        tagContainer.className = "mt-2 flex flex-wrap gap-2";

        const tagTextsForFilter = []; // í•„í„°ë§ìš© ë¬¸ìì—´ ëª¨ìŒ

        tagList.forEach(tag => {
          const span = document.createElement("span");
          span.className = `inline-block text-sm px-2 py-1 rounded ${tag.class}`;
          span.textContent = tag.text;
          tagContainer.appendChild(span);

          const plainText = tag.text.replace(/^[^ê°€-í£a-zA-Z]+/, '').trim(); 
          tagTextsForFilter.push(plainText);
        });

        // âœ… ìŠ¤í‹°ì»¤ ì—¬ë¶€ì— ë”°ë¼ ì´ë¯¸ì§€ URL ì„ íƒ
        const finalImageUrl = useFairImage ? imageSrc : proxyImageSrc;

        // ì¹´ë“œ ìƒì„±
        const li = document.createElement("li");
        li.className = "border rounded-md p-4 mb-4 bg-white shadow-sm";

        li.innerHTML = `
          <div class="flex gap-4 items-start">
            <img
              src="${finalImageUrl}"
              alt="ì¸ë„¤ì¼"
              class="w-24 h-24 sm:w-32 sm:h-32 object-cover bg-gray-100 border rounded-md"
              style="user-select: none;"
              onerror="this.style.display='none'"
            />
            <div class="flex-1">
              <h2 class="text-lg font-semibold"><a href="${post.url}" target="_blank">${post.title}</a></h2>
              <p class="text-sm text-gray-500">${post.date}</p>
              ${!hasFair ? `<p class="text-sm mt-1 text-gray-700">${post.first_100_chars}</p>` : ''}
            </div>
          </div>
        `;
        
        // li ì•ˆì˜ .flex-1 ì˜ì—­ì— tagContainer ì¶”ê°€
        li.querySelector(".flex-1").appendChild(tagContainer);
        li.setAttribute("data-tags", tagTextsForFilter.join(" "));
        list.appendChild(li);
      });
    }

    function renderTxt(posts) {
      const suspiciousPosts = posts.filter(p =>
        p.fair_trade_img_url && p.fair_trade_img_position !== 1
      );

      // ë„ë©”ì¸ ê·¸ë£¹í™”
      const grouped = {};

      suspiciousPosts.forEach(post => {
        const domainAlias = getDomainAlias(post.fair_trade_img_url);
        if (!grouped[domainAlias]) grouped[domainAlias] = [];
        grouped[domainAlias].push(post);
      });

      let txt = "ğŸ“Œ [ê³µì •ìœ„ ë¬¸êµ¬ ìˆìŒ + ì²« ë²ˆì§¸ ì•„ë‹˜ â†’ ì˜ì‹¬ ê²Œì‹œê¸€]\n";
      txt += `ì´ ${suspiciousPosts.length}ê±´\n`;
      txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n";

      for (const domainAlias of Object.keys(grouped)) {
        txt += `ğŸ”¸ ${domainAlias}\n`;
        txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

        grouped[domainAlias].forEach((p, idx) => {
          txt += `${idx + 1}) ${p.title || "(ì œëª© ì—†ìŒ)"}\n`;
          txt += `   ğŸ“ ë§í¬: ${p.url}\n`;
          txt += `   ğŸ–¼ï¸ ìœ„ì¹˜: ${p.fair_trade_img_position}ë²ˆì§¸\n\n`;
        });
      }

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "ì „ì²´" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }


    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");

      if (!blogId) {
        alert("ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      showLoading();
      const loadingText = document.getElementById("loadingText");
      const domainList = Object.keys(fairDomainAliasMap);
      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";

      try {
        // ğŸ“¥ 1ë‹¨ê³„: ì„œë²„ì— ëª©ë¡ ìš”ì²­
        loadingText.textContent = "ğŸ“¥ ë¸”ë¡œê·¸ ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        const postListRes = await fetch(`${BASE_URL}/get_post_list`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogId, pageNum })
        });

        if (!postListRes.ok) throw new Error("ë„¤ì´ë²„ ë¸”ë¡œê·¸ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
        const postData = await postListRes.json();
        const items = postData.items || [];

        if (items.length === 0) {
          alert("ğŸ“­ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ğŸ” 2ë‹¨ê³„: ê°œë³„ í¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì²­
        const allPosts = [];
        loadingText.textContent = `ğŸ” ì´ ${items.length}ê°œ í¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`;

        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const postUrl = `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`;

          const res = await fetch(`${BASE_URL}/analyze_single`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              postUrl,
              fairTradeImageLinks: domainList
            })
          });

          if (!res.ok) {
            console.warn(`âš ï¸ ë¶„ì„ ì‹¤íŒ¨ (${i + 1}/${items.length})`);
            continue;
          }

          const parsed = await res.json();
          allPosts.push(parsed);

          updateProgress(i + 1, items.length);
          loadingText.textContent = `â³ ${i + 1} / ${items.length} í¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`;
        }

        // ğŸŸ¢ 3ë‹¨ê³„: ê²°ê³¼ ë Œë”ë§
        renderPosts(allPosts);
        renderTxt(allPosts);
        loadingText.textContent = `âœ… ë¶„ì„ ì™„ë£Œ! ì´ ${allPosts.length}ê±´`;

      } catch (err) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", err);
        alert("âš ï¸ ë¸”ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        hideLoading();
      }
    }


  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="qoyiCn5HdEafxTpuvuTjg9UAPNcl__rm0N85A-RChtU" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YRHK2QVDMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YRHK2QVDMT');
  </script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬ê¸°</h1>
    
    <!-- ë¸”ë¡œê·¸ ID ì…ë ¥ -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">ë¸”ë¡œê·¸ ID ì…ë ¥:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 min-w-[120px] px-3 py-2 border rounded text-sm" placeholder="ì˜ˆ: blogpeople" />
        <div class="flex items-center gap-1 text-sm">
          <label for="pageNum" class="text-gray-600"> </label>

          <select id="pageNum" class="border rounded px-2 py-1 text-sm">
            <option value="1" selected>1í˜ì´ì§€</option>
            <option value="2">2í˜ì´ì§€</option>
            <option value="3">3í˜ì´ì§€</option>
            <option value="4">4í˜ì´ì§€</option>
            <option value="5">5í˜ì´ì§€</option>
            <option value="6">6í˜ì´ì§€</option>
            <option value="7">7í˜ì´ì§€</option>
            <option value="8">8í˜ì´ì§€</option>
            <option value="9">9í˜ì´ì§€</option>
            <option value="10">10í˜ì´ì§€</option>
          </select>

          <span class="text-gray-600">  </span>
          <!-- âœ… ì„ íƒ ê²°ê³¼ ì•ˆë‚´ -->
        </div>
        <button id="startBtn" onclick="fetchBlogPosts()" class="bg-blue-600 text-white px-4 py-2 rounded whitespace-nowrap hover:bg-blue-700 transition text-sm">ê²€ì‚¬ ì‹œì‘</button>
      </div>
    </div>

    <div id="loadingText" class="mt-2 text-sm text-blue-700 hidden">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 mb-6 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <!-- ì •ë ¬ ë°©ì‹ -->
    <div class="mb-2 text-sm font-semibold text-gray-700">ğŸ§­ ì •ë ¬ ë°©ì‹</div>
    <div id="tagFilter" class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">ì „ì²´</button>
      <button onclick="filterByTag('ê³µì •ìœ„O')" class="px-3 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200">ê³µì •ìœ„O</button>
      <button onclick="filterByTag('ê³µì •ìœ„X')" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">ê³µì •ìœ„X</button>
      <button onclick="filterByTag('ìƒë‹¨')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">ìƒë‹¨</button>
      <button onclick="filterByTag('í•˜ë‹¨')" class="px-3 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200">í•˜ë‹¨</button>
      <button onclick="filterByTag('ìŠ¤í‹°ì»¤')" class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200">ìŠ¤í‹°ì»¤</button>
    </div>

    <!-- ë³´ê¸° ë°©ì‹ -->
    <div class="mb-2 text-sm font-semibold text-gray-700">ğŸ–¼ ë³´ê¸° ë°©ì‹</div>
    <div class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="setViewMode('list')" id="btnListView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">â˜° ë¦¬ìŠ¤íŠ¸</button>
      <button onclick="setViewMode('grid')" id="btnGridView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">ğŸ”² ê·¸ë¦¬ë“œ</button>
      <button onclick="setViewMode('summary')" id="btnSummaryView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">ğŸ“„ ìš”ì•½</button>
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ: ìš”ì•½ ë³´ê¸° ëª¨ë“œì—ì„œë§Œ í‘œì‹œ -->
    <section id="summaryBox" class="mt-8 hidden">
      <h2 class="text-lg font-semibold mb-2">ğŸ“„ ìš”ì•½ ë³´ê¸°</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT ë‹¤ìš´ë¡œë“œ</button>
    </section>

    
    <!-- ê²°ê³¼ í‘œì‹œ -->
    <ul id="postList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
      <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
      <li id="emptyMessage" class="col-span-full text-center text-gray-500 py-10">
        ğŸ” ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•˜ê³  [ê²€ì‚¬ ì‹œì‘]ì„ ëˆ„ë¥´ë©´ ì´ê³³ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </li>
    </ul>

    <!-- ê³µì •ìœ„ ë„ë©”ì¸ ê´€ë¦¬ -->
    <section class="mt-8 mb-6">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">âš™ï¸ ê³µì •ìœ„ ì´ë¯¸ì§€ ë„ë©”ì¸ ëª©ë¡</h2>
      <div class="bg-gray-50 border rounded px-4 py-3">
        <ul id="fairLinkList" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-700 list-none p-0 m-0"></ul>
      </div>
    </section>

    <!-- í…ŒìŠ¤íŠ¸/ìš´ì˜ ëª¨ë“œ ìƒíƒœ í‘œì‹œ -->
    <div id="buildModeLabel" class="fixed bottom-2 left-2 text-xs text-white bg-gray-500 px-2 py-1 rounded opacity-70 z-50">
      ëª¨ë“œ í‘œì‹œ ì¤‘...
    </div>
    
    <!-- ìš°ì¸¡ ìƒë‹¨ ê³ ì • ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div id="adminAuth" class="fixed top-2 right-2 z-50 space-x-2">
      <button id="loginBtn" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">ğŸ” ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="hidden text-xs bg-gray-600 text-white px-2 py-1 rounded">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ ë·°ì–´ -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
      <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-[90vw] max-h-[90vh] rounded shadow-lg border bg-white" />
    </div>


    <!-- í† ê¸€ ë²„íŠ¼ -->
    <button onclick="toggleGuestbook()"
      class="fixed bottom-4 right-4 z-50 bg-blue-600 text-white px-3 py-2 rounded">
      ğŸ’¬ ë°©ëª…ë¡
    </button>

    <!-- âœ… ëª¨ë°”ì¼: hidden, PC: block -->
    <div id="guestbook" class="hidden fixed top-20 right-4 w-72 bg-white border rounded shadow-lg p-4 z-50 text-sm" style="top: 150px;">
      <h3 class="text-lg font-bold mb-2">ğŸ““ ë°©ëª…ë¡</h3>
      <form id="guestbookForm" class="mb-2">
        <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„" class="w-full mb-1 px-2 py-1 border rounded" />
        <textarea id="message" placeholder="í•œ ì¤„ ë©”ì‹œì§€" class="w-full px-2 py-1 border rounded"></textarea>
        <button type="submit" class="mt-2 w-full bg-blue-600 text-white px-2 py-1 rounded">ì‘ì„±</button>
      </form>
      <ul id="guestbookList" class="space-y-1 max-h-48 overflow-auto text-xs text-gray-700"></ul>
    </div>
    
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginFormBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white border rounded shadow-lg p-6 w-80 relative">
        <!-- âœ… ë‹«ê¸° ë²„íŠ¼ -->
        <button id="closeLoginBtn"
          class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl font-bold">&times;</button>

        <h3 class="text-lg font-semibold mb-4 text-center">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <form id="loginForm" class="space-y-3">
          <input id="loginEmail" type="email" placeholder="ì´ë©”ì¼" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <button type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const isTestMode = location.origin.includes("127.0.0.1") || location.origin.includes("localhost");

    const modeLabel = document.getElementById("buildModeLabel");
    if (isTestMode) {
      modeLabel.textContent = "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë¡œì»¬)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-yellow-600");
    } else {
      modeLabel.textContent = "âœ… ìµœì¢… ë¹Œë“œ (20250514_1340)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-green-700");
    }

    const fairDomainAliasMap = {
      "ê°•ë‚¨ë§›ì§‘.net": "ê°•ë‚¨ë§›ì§‘",        
      "xn--939au0g4vj8sq.net": "ê°•ë‚¨ë§›ì§‘",        
      "blogmall.net": "ë¯¸ë¸”",        
      "d3i7y4ugnppb9p.cloudfront.net": "ìŠˆí¼ë©¤ë²„ìŠ¤",        
      "www.reviewnote.co.kr": "ë¦¬ë·°ë…¸íŠ¸",        
      "dinnerqueen.net": "ë””ë„ˆì˜ì—¬ì™•",        
      "revu.net": "ë ˆë·°",        
      "reviewplace.co.kr": "ë¦¬ë·°í”Œë ˆì´ìŠ¤",       
      "nugunablog.co.kr": "í´ë¼ìš°ë“œë¦¬ë·°",  
      "tble.kr": "í‹°ë¸”",  
      "seoulouba.co.kr": "ì„œìš¸ì˜¤ë¹ ",  
      "dailyview.kr": "ë°ì¼ë¦¬ë·°",  
      "assaview.co.kr": "ì•„ì‹¸ë·°",     
      "ringble.co.kr": "ë§ë¸”",       
      "blogdexreview.space": "ë¸”ë±ìŠ¤",    
      "chvu_01.jpg": "ì²´í—˜ë·°",    
      "chvu_02.jpg": "ì²´í—˜ë·°",    
      "chvu_03.jpg": "ì²´í—˜ë·°",    
      "cometoplay.kr": "ë†€ëŸ¬ì™€",    
      "ê°€ë³´ìì²´í—˜ë‹¨.com": "ê°€ë³´ì",    
      "xn--o39a04kpnjo4k9hgflp.com": "ê°€ë³´ì",    
      "sioneview.com": "ì‹œì›ë·°",    
      "kormedia.co.kr": "ì˜¤ë§ˆì´ë¸”ë¡œê·¸",    
      "ë¸”ë¡œê·¸ì›ì •ëŒ€.com": "ë¸”ë¡œê·¸ì›ì •ëŒ€",    
      "xn--2i0bl9gt7ekxgr7lzzb.com": "ë¸”ë¡œê·¸ì›ì •ëŒ€",    
      "ëª¨ë‘ëª¨ì—¬ì²´í—˜ë‹¨.com": "ëª¨ë‘ëª¨ì—¬",    
      "xn--6j1br0ag3lba435lvsj96p.com": "ëª¨ë‘ëª¨ì—¬",    
      "unnispick.com": "ì–¸ë‹ˆìŠ¤í”½",    
      "mateb.kr": "ê¸°íƒ€ì²´í—˜ë‹¨"          
    };

    function getDomainAlias(imageUrl) {
      for (const domain in fairDomainAliasMap) {
        if (imageUrl.includes(domain)) {
          return fairDomainAliasMap[domain];
        }
      }
      return "ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ";
    }

    //function renderFairLinks() {
    //  const list = document.getElementById("fairLinkList");
    //  list.innerHTML = "";
    //
    //  Object.entries(fairDomainAliasMap).forEach(([domain, name], idx) => {
    //    const li = document.createElement("li");
    //    li.innerHTML = `${idx + 1}. <strong>${name}</strong> <span class="text-gray-500 text-sm">(${domain})</span>`;
    //    list.appendChild(li);
    //  });
    //}

    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";

      const basePath = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');

      const seenNames = new Set();  // ì¤‘ë³µ ì œê±°ìš©

      Object.entries(fairDomainAliasMap).forEach(([domain, name]) => {
        if (seenNames.has(name)) return;  // ì¤‘ë³µëœ ì´ë¦„ì€ ê±´ë„ˆëœ€
        seenNames.add(name);

        const a = document.createElement("a");
        a.href = `http://${domain}`;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "inline-block box-border p-[5px_8px_6px] border border-gray-200 rounded-[6px] text-center w-20 h-10 flex items-center justify-center text-xs font-semibold text-gray-600";

        a.onclick = (e) => e.preventDefault();  // âœ… ë§í¬ í´ë¦­ ë°©ì§€

        const img = new Image();
        img.src = `${basePath}/img/${name}.png`;
        img.alt = name;
        img.className = "w-full h-full object-contain";

        img.onload = () => {
          a.textContent = "";
          a.appendChild(img);
        };

        img.onerror = () => {
          a.textContent = name;
        };

        list.appendChild(a);
      });
    }


    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingText").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
      document.getElementById("loadingText").classList.add("hidden");
    }

    // ì´ˆê¸° ë Œë”
    renderFairLinks();

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    // í¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderPosts(posts) {
    const list = document.getElementById("postList");
    list.innerHTML = "";

    const emptyMsg = document.getElementById("emptyMessage");
    if (emptyMsg) emptyMsg.remove();

    posts.forEach(post => {
      const hasFair = post.fair_trade_img_url;
      const useFairImage = hasFair && post.fair_trade_img_position === 1;
      const hasSticker = post.first_image_url?.includes("storep-phinf");

      // âœ… ìš°ì„ ìˆœìœ„: ê³µì •ìœ„ ìƒë‹¨ ì´ë¯¸ì§€ > ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ > ì¼ë°˜ ì¸ë„¤ì¼
      let imageSrc = useFairImage
        ? post.fair_trade_img_url
        : hasSticker
          ? post.first_image_url
          : post.first_image_url;

      if (imageSrc.includes("ê°•ë‚¨ë§›ì§‘.net")) {
        imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
      }

      if (!useFairImage && imageSrc.includes("type=w") && imageSrc.includes("_blur")) {
        imageSrc = imageSrc.replace(/type=w\d+_blur/, 'type=w800');
      }

      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const encodedUrl = encodeURIComponent(imageSrc);
      const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
      const finalImageUrl = useFairImage ? imageSrc : proxyImageSrc;

      // íƒœê·¸ ì •ë¦¬
      const tagList = [];
      const tagTextsForFilter = [];

      if (hasFair) {
        tagList.push({ text: "ê³µì •ìœ„O", class: "bg-green-100 text-green-800" });
        tagTextsForFilter.push("ê³µì •ìœ„O");

        if (post.fair_trade_img_position === 1) {
          tagList.push({ text: "ìƒë‹¨", class: "bg-blue-100 text-blue-800" });
          tagTextsForFilter.push("ìƒë‹¨");
        } else {
          tagList.push({ text: "í•˜ë‹¨", class: "bg-red-100 text-red-800" });
          tagTextsForFilter.push("í•˜ë‹¨");
        }
      } else {
        tagList.push({ text: "ê³µì •ìœ„X", class: "bg-gray-200 text-gray-800" });
        tagTextsForFilter.push("ê³µì •ìœ„X");
      }

      if (post.first_image_url?.includes("storep-phinf")) {
        tagList.push({ text: "ìŠ¤í‹°ì»¤", class: "bg-yellow-100 text-yellow-800" });
        tagTextsForFilter.push("ìŠ¤í‹°ì»¤");
      }

      // ì¹´ë“œ ìš”ì†Œ ìƒì„±
      const li = document.createElement("li");
      li.className = currentViewMode === 'grid'
        ? "border rounded-md p-2 bg-white shadow-sm flex flex-col text-sm min-h-[180px]"
        : "border rounded-md p-4 mb-4 bg-white shadow-sm";
      li.setAttribute("data-tags", tagTextsForFilter.join(" "));

      const wrapper = document.createElement("div");
      wrapper.className = "flex gap-4 items-start";

      const imageWrapper = document.createElement("div");
      imageWrapper.className = "relative";

      const img = document.createElement("img");
      img.src = finalImageUrl;
      img.alt = "ì¸ë„¤ì¼";
      img.className = useFairImage
        ? "w-24 h-24 sm:w-32 sm:h-32 object-contain bg-gray-100 border rounded-md"
        : "w-24 h-24 sm:w-32 sm:h-32 object-cover bg-gray-100 border rounded-md";
      img.style.userSelect = "none";
      img.onerror = () => { img.style.display = "none"; };

      // âœ… í´ë¦­ ì‹œ ëª¨ë‹¬ ì´ë¯¸ì§€ í™•ëŒ€
      img.addEventListener("click", () => {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        modalImg.src = finalImageUrl;
        modal.classList.remove("hidden");
      });

      imageWrapper.appendChild(img);
      wrapper.appendChild(imageWrapper);

      const content = document.createElement("div");
      content.className = "flex-1 overflow-hidden";

      const title = document.createElement("h2");
      title.className = "font-semibold text-sm leading-snug line-clamp-2 overflow-hidden";
      title.innerHTML = `<a href="${post.url}" target="_blank">${post.title}</a>`;

      const date = document.createElement("p");
      date.className = "text-sm text-gray-500";
      date.textContent = post.date;

      content.appendChild(title);
      content.appendChild(date);

      if (!hasFair) {
        const summary = document.createElement("p");
        summary.className = "text-xs text-gray-500 mt-1 overflow-hidden";
        summary.style.display = "-webkit-box";
        summary.style.webkitLineClamp = "2";
        summary.style.webkitBoxOrient = "vertical";
        summary.style.lineHeight = "1.2rem";
        summary.style.maxHeight = "2.4rem";
        summary.textContent = post.first_100_chars;
        content.appendChild(summary);
      }

      const tagContainer = document.createElement("div");
      tagContainer.className = "mt-auto pt-2 flex flex-wrap gap-1";
      tagList.forEach(tag => {
        const span = document.createElement("span");
        span.className = `text-xs px-2 py-0.5 rounded ${tag.class}`;
        span.textContent = tag.text;
        tagContainer.appendChild(span);
      });

      content.appendChild(tagContainer);
      wrapper.appendChild(content);
      li.appendChild(wrapper);
      list.appendChild(li);
    });
  }


    function renderTxt(posts) {
      const suspiciousPosts = posts.filter(p =>
        p.fair_trade_img_url && p.fair_trade_img_position !== 1
      );

      // ë„ë©”ì¸ ê·¸ë£¹í™”
      const grouped = {};

      suspiciousPosts.forEach(post => {
        const domainAlias = getDomainAlias(post.fair_trade_img_url);
        if (!grouped[domainAlias]) grouped[domainAlias] = [];
        grouped[domainAlias].push(post);
      });

      let txt = "ğŸ“Œ [ê³µì •ìœ„ ë¬¸êµ¬ ìˆìŒ + ì²« ë²ˆì§¸ ì•„ë‹˜ â†’ ì˜ì‹¬ ê²Œì‹œê¸€]\n";
      txt += `ì´ ${suspiciousPosts.length}ê±´\n`;
      txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n";

      for (const domainAlias of Object.keys(grouped)) {
        txt += `ğŸ”¸ ${domainAlias}\n`;
        txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

        grouped[domainAlias].forEach((p, idx) => {
          txt += `${idx + 1}) ${p.title || "(ì œëª© ì—†ìŒ)"}\n`;
          txt += `   ğŸ“ ë§í¬: ${p.url}\n`;
          txt += `   ğŸ–¼ï¸ ìœ„ì¹˜: ${p.fair_trade_img_position}ë²ˆì§¸\n\n`;
        });
      }

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "ì „ì²´" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }

    let currentViewMode = 'list';

    function setViewMode(mode) {
      currentViewMode = mode;
      const listEl = document.getElementById('postList');
      const summaryEl = document.getElementById('summaryBox');

      if (mode === 'summary') {
        listEl.style.display = "none";
        summaryEl.style.display = "block";
      } else {
        listEl.style.display = "grid";
        summaryEl.style.display = "none";

        listEl.className = mode === 'grid'
          ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
          : 'space-y-4';
      }

      // ë²„íŠ¼ ê°•ì¡° ìŠ¤íƒ€ì¼
      ['btnListView', 'btnGridView', 'btnSummaryView'].forEach(id => {
        document.getElementById(id).classList.remove("bg-blue-600", "text-white");
      });
      const activeBtn = document.getElementById(`btn${capitalize(mode)}View`);
      activeBtn.classList.add("bg-blue-600", "text-white");
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }



    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");

      if (!blogId) {
        alert("ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      // ğŸ‘‰ ë²„íŠ¼ ë¹„í™œì„±í™”
      startBtn.disabled = true;
      startBtn.classList.add("opacity-50", "cursor-not-allowed");

      showLoading();
      const loadingText = document.getElementById("loadingText");
      const domainList = Object.keys(fairDomainAliasMap);
      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const analyzeSingleUrl = `${BASE_URL}/analyze_single`;
      const postListUrl = `${BASE_URL}/get_post_list`;

      try {
        // â± ì „ì²´ ì‹œê°„ ì¸¡ì • ì‹œì‘
        const startTime = performance.now();

        // ğŸ“¥ 1ë‹¨ê³„: ì„œë²„ì—ì„œ í¬ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ë°›ì•„ì˜¤ê¸°
        loadingText.textContent = "ğŸ“¥ ë¸”ë¡œê·¸ ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        const res = await fetch(postListUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogId, pageNum })
        });

        if (!res.ok) throw new Error("ë„¤ì´ë²„ ë¸”ë¡œê·¸ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
        const data = await res.json();
        const items = data.items || [];

        if (items.length === 0) {
          alert("ğŸ“­ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const urls = items.map(item =>
          `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`
        );

        // ğŸ” 2ë‹¨ê³„: ë³‘ë ¬ ë¶„ì„ (nê°œì”©)
        const allPosts = new Array(urls.length); // ê²°ê³¼ ì €ì¥ìš© (ì •ë ¬ ìœ ì§€)
        const batchSize = 8;
        let completed = 0;

        for (let i = 0; i < urls.length; i += batchSize) {
          const batch = urls.slice(i, i + batchSize);

          const tasks = batch.map((postUrl, idx) => {
            const realIdx = i + idx; // ì „ì²´ ì¸ë±ìŠ¤
            return fetch(analyzeSingleUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                postUrl,
                fairTradeImageLinks: domainList
              })
            })
              .then(r => r.ok ? r.json() : null)
              .catch(() => null)
              .then(result => {
                allPosts[realIdx] = result; // âœ… ìˆœì„œì— ë§ì¶° ì €ì¥
                completed++;
                updateProgress(completed, urls.length);
                loadingText.textContent = `â³ ${completed} / ${urls.length} í¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`;
              });
          });

          await Promise.allSettled(tasks);
        }

        // ğŸŸ¢ 3ë‹¨ê³„: ê²°ê³¼ ë Œë”ë§
        const filteredPosts = allPosts.filter(p => p !== null);
        renderPosts(filteredPosts);
        //renderPosts(allPosts);
        renderTxt(allPosts);
        loadingText.textContent = `âœ… ë¶„ì„ ì™„ë£Œ! ì´ ${allPosts.length}ê±´`;

        // â± ì†Œìš” ì‹œê°„ ë¡œê·¸ ì¶œë ¥
        const endTime = performance.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        const avg = (elapsed / completed).toFixed(2);
        console.log(`âœ… ì „ì²´ ë¶„ì„ ì‹œê°„: ${elapsed}ì´ˆ`);
        console.log(`â± í¬ìŠ¤íŠ¸ë‹¹ í‰ê·  ë¶„ì„ ì‹œê°„: ${avg}ì´ˆ`);

      } catch (err) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", err);
        alert("âš ï¸ ë¸”ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        
        // ğŸ‘‰ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        startBtn.disabled = false;
        startBtn.classList.remove("opacity-50", "cursor-not-allowed");

        hideLoading();
      }
    }
  </script>
  

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      deleteDoc,       // âœ… ì´ ì¤„ ì¶”ê°€!
      doc              // âœ… ì´ ì¤„ë„ í•¨ê»˜ í•„ìš” (ë¬¸ì„œ ì°¸ì¡°ìš©)
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD2EEBetGbTQLhd7EUA21yYGHP0WOk5wIE",
      authDomain: "fairblog-e5054.firebaseapp.com",
      projectId: "fairblog-e5054",
      storageBucket: "fairblog-e5054.firebasestorage.app",
      messagingSenderId: "521579840672",
      appId: "1:521579840672:web:d00975b2bd5255639875c5",
      measurementId: "G-HNBS1KD7JX"
    };

    window.toggleGuestbook = function () {
      const guestbook = document.getElementById("guestbook");
      console.log("í† ê¸€ ì „:", guestbook.className);
      guestbook.classList.toggle("hidden");
      console.log("í† ê¸€ í›„:", guestbook.className);
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app)
    const db = getFirestore(app);
    const auth = getAuth();

    let isAdmin = false;

    document.getElementById("loginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.toggle("hidden");
    };

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("âœ… ë¡œê·¸ì¸ ì„±ê³µ");
        document.getElementById("loginFormBox").classList.add("hidden");
      } catch (err) {
        alert("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message);
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("loginFormBox").classList.add("hidden");
      }
    });

    document.getElementById("closeLoginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.add("hidden");
    };
    
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("ğŸšª ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤");
    };

    // âœ… Auth ìƒíƒœ ê°ì§€ â†’ startGuestbookListener í˜¸ì¶œ
    onAuthStateChanged(auth, async (user) => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (!loginBtn || !logoutBtn) {
        console.warn("â— loginBtn ë˜ëŠ” logoutBtn ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        //console.log("âœ… ë¡œê·¸ì¸ë¨:", user.email);
        //console.log("ğŸ›¡ isAdmin:", isAdmin);

        // âœ… ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¹€, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

      } else {
        isAdmin = false;

        // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¹€
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }

      const nicknameInput = document.getElementById("nickname");
      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        if (isAdmin) {
          nicknameInput.value = "ê´€ë¦¬ì";
          nicknameInput.disabled = true;
        } else {
          nicknameInput.disabled = false;
        }
      } else {
        isAdmin = false;
        nicknameInput.disabled = false;
      }

      startGuestbookListener(); // â† ì—¬ê¸°ì„œ UI ë‹¤ì‹œ ë Œë”
    });

    // âœ… ì´ ë¶€ë¶„ì´ ì‹¤ì‹œê°„ ë°©ëª…ë¡ ë¦¬ìŠ¤ë„ˆ ì •ì˜
    function startGuestbookListener() {
      const q = query(
        collection(db, "guestbook"),
        orderBy("timestamp", "asc"),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        const list = document.getElementById("guestbookList");
        list.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");

          // âœ… ê¸°ë³¸ ìŠ¤íƒ€ì¼
          //li.className = "flex justify-between items-center border-b py-1";
          li.className = "flex flex-col justify-between h-full min-h-[200px] border rounded-md p-2 bg-white shadow-sm text-sm";


          // âœ… ê´€ë¦¬ì ë‹‰ë„¤ì„ ìŠ¤íƒ€ì¼ë§
          const isAdminMessage = data.nickname === "ê´€ë¦¬ì";

          li.innerHTML = `
            <span class="${isAdminMessage ? 'text-blue-600 font-bold' : ''}">
              ğŸ—£ ${data.nickname}: ${data.message}
            </span>
          `;

          // âœ… ì‚­ì œ ë²„íŠ¼ì€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¼ ë•Œë§Œ
          if (isAdmin) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "ì‚­ì œ";
            delBtn.className = "text-xs text-red-500 hover:underline ml-2";
            delBtn.onclick = async () => {
              if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "guestbook", docSnap.id));
              }
            };
            li.appendChild(delBtn);
          }

          list.appendChild(li);
        });
      });
    }

    function generateRandomNickname() {
      const adjectives = ["ê·€ì—¬ìš´", "ëŠê¸‹í•œ", "í™œë°œí•œ", "ìš©ê°í•œ", "ìš°ì•„í•œ", "ë¹ ë¥¸", "ì¡°ìš©í•œ", "ì—‰ëš±í•œ"];
      const animals = ["í† ë¼", "ê³ ì–‘ì´", "ê°•ì•„ì§€", "íŒë‹¤", "ìˆ˜ë‹¬", "ì—¬ìš°", "í•˜ë§ˆ", "ë‹¤ëŒì¥"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      return `${adj} ${animal}`;
    }
    
    // âœ… ë°©ëª…ë¡ ì‘ì„± ì²˜ë¦¬
    const form = document.getElementById("guestbookForm");
    const nicknameInput = document.getElementById("nickname");
    const messageInput = document.getElementById("message");
    const list = document.getElementById("guestbookList");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let nickname = nicknameInput.value.trim();
      const message = messageInput.value.trim();
      if (!message) return;

      // âœ… ê´€ë¦¬ìì¼ ê²½ìš° ë‹‰ë„¤ì„ì€ ê³ ì •
      if (isAdmin) {
        nickname = "ê´€ë¦¬ì";
      }

      // âœ… ì¼ë°˜ ì‚¬ìš©ìëŠ” "ê´€ë¦¬ì" ë‹‰ë„¤ì„ ê¸ˆì§€
      if (nickname === "ê´€ë¦¬ì" && !isAdmin) {
        alert("âŒ 'ê´€ë¦¬ì'ë¼ëŠ” ë‹‰ë„¤ì„ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ë¹„ì–´ ìˆê±°ë‚˜ ìë™ ì…ë ¥ ì‹œ ëœë¤ ìƒì„±
      if (!nickname) {
        nickname = generateRandomNickname();
      }

      try {
        await addDoc(collection(db, "guestbook"), {
          nickname,
          message,
          timestamp: serverTimestamp()
        });
        messageInput.value = "";
      } catch (err) {
        console.error("ğŸ”¥ ë°©ëª…ë¡ ì €ì¥ ì‹¤íŒ¨:", err);
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const nicknameInput = document.getElementById("nickname");
      if (!nicknameInput.value) {
        nicknameInput.value = generateRandomNickname();  // âœ… ì‹¤ì œ ì…ë ¥ê°’ìœ¼ë¡œ ì„¤ì •
      }

      const guestbook = document.getElementById("guestbook");
      if (window.innerWidth < 640) {
        guestbook.classList.add("hidden");
      } else {
        guestbook.classList.remove("hidden");
      }
    });

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('imageModal').classList.add('hidden');
      }
    });

  </script>
</body>
</html>

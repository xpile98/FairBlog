<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³µì •ìœ„ ë¸”ë¡œê·¸ ê²€ì‚¬ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ ê³µì •ìœ„ ë¸”ë¡œê·¸ ê²€ì‚¬ê¸°</h1>
    
    <!-- ë¸”ë¡œê·¸ ID ì…ë ¥ -->
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700">ë¸”ë¡œê·¸ ID ì…ë ¥:</label>
      <div class="flex mt-1">
        <input type="text" id="blogId" class="flex-1 border rounded px-3 py-2" placeholder="ì˜ˆ: blogpeople" />
        <div class="flex items-center gap-1 text-sm">
          <label for="pageNum" class="text-gray-600"> </label>

          <select id="pageNum" class="border rounded px-2 py-1 text-sm">
            <option value="1" selected>1í˜ì´ì§€</option>
            <option value="2">2í˜ì´ì§€</option>
            <option value="3">3í˜ì´ì§€</option>
            <option value="4">4í˜ì´ì§€</option>
            <option value="5">5í˜ì´ì§€</option>
            <option value="6">6í˜ì´ì§€</option>
            <option value="7">7í˜ì´ì§€</option>
            <option value="8">8í˜ì´ì§€</option>
            <option value="9">9í˜ì´ì§€</option>
            <option value="10">10í˜ì´ì§€</option>
          </select>

          <span class="text-gray-600">íƒìƒ‰</span>
          <!-- âœ… ì„ íƒ ê²°ê³¼ ì•ˆë‚´ -->
        </div>
        <button onclick="fetchBlogPosts()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">ê²€ì‚¬ ì‹œì‘</button>
      </div>
    </div>

    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <div id="tagFilter" class="mb-4 flex flex-wrap gap-2">
      <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 bg-gray-300 rounded">ì „ì²´</button>
      <button onclick="filterByTag('ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ')" class="px-3 py-1 bg-gray-300 rounded">ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ</button>
      <button onclick="filterByTag('ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ')" class="px-3 py-1 bg-gray-300 rounded">ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ</button>
      <button onclick="filterByTag('ìƒë‹¨ ë°°ì¹˜')" class="px-3 py-1 bg-gray-300 rounded">ìƒë‹¨ ë°°ì¹˜</button>
      <button onclick="filterByTag('í•˜ë‹¨ ë°°ì¹˜')" class="px-3 py-1 bg-gray-300 rounded">í•˜ë‹¨ ë°°ì¹˜</button>
      <button onclick="filterByTag('ìŠ¤í‹°ì»¤ ìˆìŒ')" class="px-3 py-1 bg-gray-300 rounded">ìŠ¤í‹°ì»¤ ìˆìŒ</button>
      <button onclick="filterByTag('ìŠ¤í‹°ì»¤ ì—†ìŒ')" class="px-3 py-1 bg-gray-300 rounded">ìŠ¤í‹°ì»¤ ì—†ìŒ</button>
    </div>


    <!-- ê²°ê³¼ í‘œì‹œ -->
    <ul id="postList" class="space-y-4"></ul>
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">ğŸ“„ ì‹ ê³ ìš© ìš”ì•½ TXT</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT ë‹¤ìš´ë¡œë“œ</button>
    </section>

    <!-- ê³µì •ìœ„ ë„ë©”ì¸ ê´€ë¦¬ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">âš™ï¸ ê³µì •ìœ„ ì´ë¯¸ì§€ ë„ë©”ì¸ ì„¤ì •</h2>
      <div class="flex gap-2 mb-2">
        <input id="fairLinkInput" type="text" placeholder="ì˜ˆ: reviewnote.co.kr/gongjeong/" class="flex-1 border rounded px-2 py-1 text-sm" />
        <button onclick="addFairLink()" class="bg-blue-600 text-white px-3 py-1 text-sm rounded">ì¶”ê°€</button>
      </div>
      <ul id="fairLinkList" class="text-sm text-gray-700 space-y-1"></ul>
    </section>

  </div>

  <script>
    
    const isTestMode = false;

    // ì „ì—­ ë¦¬ìŠ¤íŠ¸
    let fairTradeImageLinks = [
      "ê°•ë‚¨ë§›ì§‘.net",                     //ê°•ë‚¨ë§›ì§‘ 1
      "xn--939au0g4vj8sq.net",           //ê°•ë‚¨ë§›ì§‘ 2
      "blogmall.net/",                   //ë¯¸ë¸”
      "d3i7y4ugnppb9p.cloudfront.net/",  //ìŠˆí¼ë©¤ë²„ìŠ¤
      "www.reviewnote.co.kr/",           //ë¦¬ë·°ë…¸íŠ¸
      "dinnerqueen.net/",                //ë””ë„ˆì˜ì—¬ì™•
      "revu.net/",                       //ë ˆë·°
      "reviewplace.co.kr/",              //ë¦¬ë·°í”Œë ˆì´ìŠ¤
      "mateb.kr/",                       //ê¸°íƒ€ì²´í—˜ë‹¨
      "postfiles.pstatic.net/"           //í´ë¼ìš°ë“œë¦¬ë·°
    ];

    // ë Œë”ë§
    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";
      fairTradeImageLinks.forEach((link, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${idx + 1}. ${link}
          <button onclick="removeFairLink(${idx})" class="ml-2 text-red-500 text-xs">âŒ</button>
        `;
        list.appendChild(li);
      });
    }

    // ì¶”ê°€
    function addFairLink() {
      const input = document.getElementById("fairLinkInput");
      const value = input.value.trim();
      if (!value) return;
      if (fairTradeImageLinks.includes(value)) {
        alert("ì´ë¯¸ ë“±ë¡ëœ ë§í¬ì…ë‹ˆë‹¤.");
        return;
      }
      fairTradeImageLinks.push(value);
      input.value = "";
      renderFairLinks();
    }

    // ì œê±°
    function removeFairLink(index) {
      fairTradeImageLinks.splice(index, 1);
      renderFairLinks();
    }

    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
    }

    // ì´ˆê¸° ë Œë”
    renderFairLinks();

    /*
    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      if (!blogId) {
        alert("ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.1");
        return;
      }

      showLoading();
      try {
        const postListRes = await fetch(`https://m.blog.naver.com/api/blogs/${blogId}/post-list?categoryNo=0&itemCount=24&page=1&userId=${blogId}`, {
          headers: {
            'User-Agent': 'Mozilla/5.0',
            'Accept': 'application/json',
            'Referer': `https://m.blog.naver.com/${blogId}`
          }
        });

        const postData = await postListRes.json();
        const items = postData.result?.items || [];

        const allPosts = [];
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const postUrl = `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`;


          if (isTestMode) {
            analyze_single = "http://localhost:3000/analyze_single";
          } else {
            analyze_single = "https://fairblog.onrender.com/analyze_single";
          }

          const res = await fetch(analyze_single, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              postUrl,
              fairTradeImageLinks
            })
          });

          if (res.ok) {
            const parsed = await res.json();
            allPosts.push(parsed);
          }

          // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
          updateProgress(i + 1, items.length);
        }

        renderPosts(allPosts);
        renderTxt(allPosts);
      } catch (err) {
        console.error("ì „ì²´ ë¶„ì„ ì‹¤íŒ¨:", err);
        alert("ë¸”ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        hideLoading();
      }
    }
    */

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    // í¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderPosts(posts) {
      const list = document.getElementById("postList");
      list.innerHTML = "";

      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const isSuspicious = hasFair && post.fair_trade_img_position !== 1;
        const useFairImage = post.fair_trade_img_url && post.fair_trade_img_position === 1;
        const imageSrc = useFairImage ? post.fair_trade_img_url : post.first_image_url;
        
        // âœ… ê°•ë‚¨ë§›ì§‘.net í¬í•¨ ì‹œ ë¬´ì¡°ê±´ ê³ ì • URLë¡œ ëŒ€ì²´
        if (imageSrc.includes("ê°•ë‚¨ë§›ì§‘.net")) {
          imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
        }

        let BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
        const encodedUrl = encodeURIComponent(imageSrc);
        const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
        
        console.log("âœ… ìµœì¢… ìš”ì²­ URL:", encodedUrl);

        // íƒœê·¸ ë°•ìŠ¤ ëª©ë¡ ì¤€ë¹„
        const tagList = [];

        if (hasFair) {
          tagList.push({ text: "âœ… ê³µì •ìœ„ ì´ë¯¸ì§€ ìˆìŒ", class: "text-green-700 bg-green-100" });

          if (post.fair_trade_img_position === 1) {
            tagList.push({ text: "ğŸ“Œ ìƒë‹¨ ë°°ì¹˜", class: "text-blue-700 bg-blue-100" });
          } else {
            tagList.push({ text: "â— í•˜ë‹¨ ë°°ì¹˜", class: "text-red-700 bg-red-100" });
          }
        } else {
          tagList.push({ text: "ğŸš« ê³µì •ìœ„ ì´ë¯¸ì§€ ì—†ìŒ", class: "text-gray-700 bg-gray-100" });
        }

        if (post.first_image_url?.includes("sticker")) {
          tagList.push({ text: "ğŸ·ï¸ ìŠ¤í‹°ì»¤ ìˆìŒ", class: "text-yellow-700 bg-yellow-100" });
        } else {
          tagList.push({ text: "ìŠ¤í‹°ì»¤ ì—†ìŒ", class: "text-gray-500 bg-gray-100" });
        }

        // DOMìœ¼ë¡œ ê°ê°ì˜ span ìš”ì†Œ ìƒì„±í•´ì„œ pì— ë¶™ì´ê¸°
        const tagContainer = document.createElement("p");
        tagContainer.className = "mt-2 flex flex-wrap gap-2";

        const tagTextsForFilter = []; // í•„í„°ë§ìš© ë¬¸ìì—´ ëª¨ìŒ

        tagList.forEach(tag => {
          const span = document.createElement("span");
          span.className = `inline-block text-sm px-2 py-1 rounded ${tag.class}`;
          span.textContent = tag.text;
          tagContainer.appendChild(span);

          const plainText = tag.text.replace(/^[^ê°€-í£a-zA-Z]+/, '').trim(); 
          tagTextsForFilter.push(plainText);
        });

        // ì¹´ë“œ ìƒì„±
        const li = document.createElement("li");
        li.className = "border rounded-md p-4 mb-4 bg-white shadow-sm";

        li.innerHTML = `
          <div class="flex gap-4 items-start">
            <img
              src="${proxyImageSrc}"
              alt="ì¸ë„¤ì¼"
              class="w-24 h-24 sm:w-32 sm:h-32 object-cover bg-gray-100 border rounded-md"
              style="user-select: none;"
              onerror="this.style.display='none'"
            />
            <div class="flex-1">
              <h2 class="text-lg font-semibold"><a href="${post.url}" target="_blank">${post.title}</a></h2>
              <p class="text-sm text-gray-500">${post.date}</p>
              ${!hasFair ? `<p class="text-sm mt-1 text-gray-700">${post.first_100_chars}</p>` : ''}
            </div>
          </div>
        `;
        
        // li ì•ˆì˜ .flex-1 ì˜ì—­ì— tagContainer ì¶”ê°€
        li.querySelector(".flex-1").appendChild(tagContainer);
        li.setAttribute("data-tags", tagTextsForFilter.join(" "));
        list.appendChild(li);
      });
    }

    function renderTxt(posts) {
      const suspiciousPosts = posts.filter(p =>
        p.fair_trade_img_url && p.fair_trade_img_position !== 1
      );

      let txt = "ğŸ“Œ [ê³µì •ìœ„ ë¬¸êµ¬ ìˆìŒ + ì²« ë²ˆì§¸ ì•„ë‹˜ â†’ ì˜ì‹¬ ê²Œì‹œê¸€]\n";
      txt += `ì´ ${suspiciousPosts.length}ê±´\n`;
      txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n";

      suspiciousPosts.forEach((p, idx) => {
        txt += `${idx + 1}) ${p.title || "(ì œëª© ì—†ìŒ)"}\n`;
        txt += `   ğŸ“ ë§í¬: ${p.url}\n`;
        txt += `   ğŸ–¼ï¸ ìœ„ì¹˜: ${p.fair_trade_img_position}ë²ˆì§¸\n`;
        txt += `   ğŸ”— ì´ë¯¸ì§€: ${p.fair_trade_img_url}\n\n`;
      });

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "ì „ì²´" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }


    async function fetchBlogPosts() {
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");

      if (!blogId) {
        alert("ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.2");
        return;
      }

      showLoading(); // âœ… ì‹œì‘ ì‹œ í‘œì‹œ

      if (isTestMode) {
        analyze_blog = "http://localhost:3000/analyze_blog";
      } else {
        analyze_blog = "https://fairblog.onrender.com/analyze_blog";
      }

      try {
        const response = await fetch(analyze_blog, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            blogId,
            fairTradeImageLinks,
            numPages: pageNum  // âœ… ì‚¬ìš©ì ì…ë ¥ê°’ì„ í•¨ê»˜ ë³´ëƒ„
          })
        });

        if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
      
        if (response.status === 429) {
          alert("â— ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ë¶„ì„ì´ ì¼ì‹œì ìœ¼ë¡œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }

        const data = await response.json();
        renderPosts(data.posts);
        renderTxt(data.posts);

      } catch (err) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", err);
        alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        hideLoading(); // âœ… í•­ìƒ ìˆ¨ê¹€
      }
    }

  </script>
</body>
</html>

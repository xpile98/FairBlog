<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬ê¸° - í˜ì–´ë¸”ë¡œê·¸</title>
  <meta name="description" content="ê³µì •ìœ„ ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì²´í—˜ë‹¨ ë² ë„ˆë¥¼ ê²€ì‚¬í•˜ëŠ” ë¬´ë£Œ ë„êµ¬ì…ë‹ˆë‹¤. ë„¤ì´ë²„ ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•˜ë©´ ê²€ì‚¬ ê²°ê³¼ê°€ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤.">
  <meta name="keywords" content="ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬, ê´‘ê³  ë¬¸êµ¬ ë¶„ì„, ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì²´í—˜ë‹¨, SNS ê´‘ê³ , í‘œì‹œê´‘ê³  ì‹¬ì‚¬ ì§€ì¹¨">
  <meta name="author" content="yongwon cho">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="qoyiCn5HdEafxTpuvuTjg9UAPNcl__rm0N85A-RChtU" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>


  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YRHK2QVDMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YRHK2QVDMT');
  </script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-4xl mx-auto">
    <section class="text-center text-gray-700 my-6">
      <h1 onclick="location.reload()" class="text-2xl font-extrabold text-blue-600 hover:text-blue-800 transition-colors duration-200 text-center block cursor-pointer">
        ê³µì •ìœ„ ë¬¸êµ¬ ê²€ì‚¬ê¸° - í˜ì–´ë¸”ë¡œê·¸
      </h1>
    </section>
    
    <div class="mb-6">
      <label for="blogId" class="block text-sm font-medium text-gray-700 mb-1">
        ë„¤ì´ë²„ ë¸”ë¡œê·¸ ID ì…ë ¥:
      </label>

      <div class="flex flex-col sm:flex-row gap-2 sm:items-center">

        <!-- ID ì…ë ¥ + í˜ì´ì§€ ì„ íƒ -->
        <div class="flex flex-1 gap-2 items-center">
          <input
            type="text"
            id="blogId"
            class="flex-1 min-w-[100px] px-3 h-[50px] border rounded text-sm"
            placeholder="ì˜ˆ: blogpeople"
          />

          <div class="flex flex-col justify-end h-[50px]">
            <label for="pageNum" class="text-xs text-gray-600 mb-1">í˜ì´ì§€</label>
            <select
              id="pageNum"
              class="w-[60px] h-[38px] px-2 border rounded text-sm"
            >
              <!-- 1~20 -->
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

        <!-- ìƒì„¸ ê²€ìƒ‰ (í† ê¸€) -->
        <div class="flex flex-col justify-end h-[50px]">
          <label for="detailedCheck" class="text-xs text-gray-600 mb-1">ìƒì„¸ ê²€ìƒ‰</label>
          <div class="h-[38px] flex items-center">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="detailedCheck" class="sr-only peer" unchecked />
              <div class="w-11 h-6 bg-gray-300 rounded-full peer-checked:bg-blue-600 transition duration-200"></div>
              <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border rounded-full transition peer-checked:translate-x-full peer-checked:border-white"></div>
            </label>
          </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="flex items-end h-[50px]">
          <button
            id="startBtn"
            onclick="fetchBlogPosts()"
            class="h-[38px] bg-blue-600 text-white px-4 rounded whitespace-nowrap hover:bg-blue-700 transition text-sm"
          >
            ê²€ì‚¬ ì‹œì‘
          </button>
        </div>

      </div>
    </div>



    <div id="loadingText" class="mt-2 text-sm text-blue-700 hidden">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
    <div id="loadingBar" class="w-full bg-gray-200 h-2 mt-4 mb-6 rounded overflow-hidden hidden">
      <div class="bg-blue-600 h-full transition-all" style="width: 0%;"></div>
    </div>

    <!-- ì •ë ¬ ë°©ì‹ -->
    <div class="mb-2 text-sm font-semibold text-gray-700">ğŸ§­ ì •ë ¬ ë°©ì‹</div>
    <div id="tagFilter" class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 rounded border bg-gray-100 text-gray-800 hover:bg-gray-200">ì „ì²´</button>
      <button onclick="filterByTag('ì •ì±… ì§€í‚´')" class="px-3 py-1 rounded border bg-green-100 text-green-800 hover:bg-green-200">ì •ì±… ì§€í‚´</button>
      <button onclick="filterByTag('ì •ì±… ìœ„ë°˜')" class="px-3 py-1 rounded border bg-red-100 text-red-800 hover:bg-red-200">ì •ì±… ìœ„ë°˜</button>
      <button onclick="filterByTag('ë‚´ëˆë‚´ì‚°')" class="px-3 py-1 rounded border bg-blue-100 text-blue-800 hover:bg-blue-200">ë‚´ëˆë‚´ì‚°</button>
      <button onclick="filterByTag('ë¶ˆë¶„ëª…')" class="px-3 py-1 rounded border bg-gray-200 text-gray-800 hover:bg-gray-300">ë¶ˆë¶„ëª…</button>
    </div>


    <!-- ë³´ê¸° ë°©ì‹ -->
    <div class="mb-2 text-sm font-semibold text-gray-700">ğŸ–¼ ë³´ê¸° ë°©ì‹</div>
    <div class="mb-4 flex flex-nowrap gap-2 overflow-x-auto whitespace-nowrap text-sm">
      <button onclick="setViewMode('list')" id="btnListView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">â˜° ë¦¬ìŠ¤íŠ¸</button>
      <button onclick="setViewMode('grid')" id="btnGridView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">ğŸ”² ê·¸ë¦¬ë“œ</button>
      <button onclick="setViewMode('summary')" id="btnSummaryView" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">ğŸ“„ ìš”ì•½</button>
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ: ìš”ì•½ ë³´ê¸° ëª¨ë“œì—ì„œë§Œ í‘œì‹œ -->
    <section id="summaryBox" class="mt-8 hidden">
      <h2 class="text-lg font-semibold mb-2">ğŸ“„ ìš”ì•½ ë³´ê¸°</h2>
      <pre id="reportContent" class="w-full p-3 bg-gray-100 border rounded text-sm whitespace-pre-wrap h-64 overflow-auto"></pre>
      <button onclick="downloadTxt()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">TXT ë‹¤ìš´ë¡œë“œ</button>
    </section>

    
    <!-- ê²°ê³¼ í‘œì‹œ -->
    <ul id="postList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch"></ul>
    
    <!-- ì´ê±´ ul ë°–ìœ¼ë¡œ ë¹¼ì•¼ .innerHTML ì˜í–¥ì„ ì•ˆ ë°›ìŒ -->
    <div id="emptyMessage" class="text-center text-gray-500 py-10">
      ğŸ” ê²°ê³¼ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    </div>

    <!-- ê³µì •ìœ„ ë„ë©”ì¸ ê´€ë¦¬ -->
    <section class="mt-8 mb-6">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">âš™ï¸ ê³µì •ìœ„ ì´ë¯¸ì§€ ë„ë©”ì¸ ëª©ë¡</h2>
      <div class="bg-gray-50 border rounded px-4 py-3">
        <ul id="fairLinkList" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-700 list-none p-0 m-0"></ul>
      </div>
    </section>

    <!-- ì •ì±… ë¬¸êµ¬ í‚¤ì›Œë“œ ì•ˆë‚´ -->
    <section class="mt-8">
      <h2 class="text-sm font-semibold text-gray-600 mb-2">ğŸ“Œ ê³µì •ìœ„ í‚¤ì›Œë“œ ëª©ë¡</h2>
      <!-- í˜‘ì°¬ ë¬¸êµ¬ í‚¤ì›Œë“œ -->
      <div class="mb-4">
        <h3 class="text-xs font-medium text-green-700 mb-1">ğŸŸ¢ í˜‘ì°¬ ë¬¸êµ¬ í‚¤ì›Œë“œ</h3>
        <div id="sponsoredKeywordTags" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- ë‚´ëˆë‚´ì‚° í‚¤ì›Œë“œ -->
      <div>
        <h3 class="text-xs font-medium text-blue-700 mb-1">ğŸ”µ ë‚´ëˆë‚´ì‚° í‚¤ì›Œë“œ</h3>
        <div id="nonSponsoredKeywordTags" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- í…ŒìŠ¤íŠ¸/ìš´ì˜ ëª¨ë“œ ìƒíƒœ í‘œì‹œ -->
    <div id="buildModeLabel" class="fixed bottom-2 left-2 text-xs text-white bg-gray-500 px-2 py-1 rounded opacity-70 z-50">
      ëª¨ë“œ í‘œì‹œ ì¤‘...
    </div>
    
    <!-- ìš°ì¸¡ ìƒë‹¨ ê³ ì • ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div id="adminAuth" class="fixed top-2 right-2 z-50 space-x-2">
      <button id="loginBtn" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">ğŸ” ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="hidden text-xs bg-gray-600 text-white px-2 py-1 rounded">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ ë·°ì–´ -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
      <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-[90vw] max-h-[90vh] rounded shadow-lg border bg-white" />
    </div>


    <!-- í† ê¸€ ë²„íŠ¼ -->
    <button onclick="toggleGuestbook()"
      class="fixed bottom-4 right-4 z-50 bg-blue-600 text-white px-3 py-2 rounded">
      ğŸ’¬ ë°©ëª…ë¡
    </button>

    <!-- âœ… ëª¨ë°”ì¼: hidden, PC: block -->
    <div id="guestbook" class="hidden fixed top-20 right-4 w-72 bg-white border rounded shadow-lg p-4 z-50 text-sm" style="top: 200px;">
      <h3 class="text-lg font-bold mb-2">ğŸ““ ë°©ëª…ë¡</h3>
      <form id="guestbookForm" class="mb-2">
        <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„" class="w-full mb-1 px-2 py-1 border rounded" />
        <textarea id="message" placeholder="í•œ ì¤„ ë©”ì‹œì§€" class="w-full px-2 py-1 border rounded"></textarea>
        <button type="submit" class="mt-2 w-full bg-blue-600 text-white px-2 py-1 rounded">ì‘ì„±</button>
      </form>
      <ul id="guestbookList" class="space-y-1 max-h-48 overflow-auto text-xs text-gray-700"></ul>
    </div>
    
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginFormBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white border rounded shadow-lg p-6 w-80 relative">
        <!-- âœ… ë‹«ê¸° ë²„íŠ¼ -->
        <button id="closeLoginBtn"
          class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl font-bold">&times;</button>

        <h3 class="text-lg font-semibold mb-4 text-center">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <form id="loginForm" class="space-y-3">
          <input id="loginEmail" type="email" placeholder="ì´ë©”ì¼" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required
            class="w-full px-3 py-2 border rounded text-sm" />
          <button type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const isTestMode = location.origin.includes("127.0.0.1") || location.origin.includes("localhost");

    const modeLabel = document.getElementById("buildModeLabel");
    if (isTestMode) {
      modeLabel.textContent = "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë¡œì»¬)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-yellow-600");
    } else {
      modeLabel.textContent = "âœ… ìµœì¢… ë¹Œë“œ (20250515_2130)";
      modeLabel.classList.remove("bg-gray-500");
      modeLabel.classList.add("bg-green-700");
    }

    const fairDomainAliasMap = {
      "ê°•ë‚¨ë§›ì§‘.net": "ê°•ë‚¨ë§›ì§‘",        
      "xn--939au0g4vj8sq.net": "ê°•ë‚¨ë§›ì§‘",        
      "%EA%B0%95%EB%82%A8%EB%A7%9B%EC%A7%91.net": "ê°•ë‚¨ë§›ì§‘",        
      "blogmall.net": "ë¯¸ë¸”",        
      "d3i7y4ugnppb9p.cloudfront.net": "ìŠˆí¼ë©¤ë²„ìŠ¤",        
      "reviewnote": "ë¦¬ë·°ë…¸íŠ¸",        
      "dinnerqueen.net": "ë””ë„ˆì˜ì—¬ì™•",        
      "revu.net": "ë ˆë·°",        
      "reviewplace.co.kr": "ë¦¬ë·°í”Œë ˆì´ìŠ¤",       
      "nugunablog.co.kr": "í´ë¼ìš°ë“œë¦¬ë·°",  
      "tble.kr": "í‹°ë¸”",  
      "seoulouba.co.kr": "ì„œìš¸ì˜¤ë¹ ",  
      "dailyview.kr": "ë°ì¼ë¦¬ë·°",  
      "assaview.co.kr": "ì•„ì‹¸ë·°",     
      "ringble.co.kr": "ë§ë¸”",       
      "blogdexreview.space": "ë¸”ë±ìŠ¤",    
      "chvu_01.jpg": "ì²´í—˜ë·°",    
      "chvu_02.jpg": "ì²´í—˜ë·°",    
      "chvu_03.jpg": "ì²´í—˜ë·°",    
      "cometoplay.kr": "ë†€ëŸ¬ì™€",    
      "ê°€ë³´ìì²´í—˜ë‹¨.com": "ê°€ë³´ì",    
      "xn--o39a04kpnjo4k9hgflp.com": "ê°€ë³´ì",    
      "sioneview.com": "ì‹œì›ë·°",    
      "kormedia.co.kr": "ì˜¤ë§ˆì´ë¸”ë¡œê·¸",    
      "ë¸”ë¡œê·¸ì›ì •ëŒ€.com": "ë¸”ë¡œê·¸ì›ì •ëŒ€",    
      "xn--2i0bl9gt7ekxgr7lzzb.com": "ë¸”ë¡œê·¸ì›ì •ëŒ€",    
      "ëª¨ë‘ëª¨ì—¬ì²´í—˜ë‹¨.com": "ëª¨ë‘ëª¨ì—¬",    
      "xn--6j1br0ag3lba435lvsj96p.com": "ëª¨ë‘ëª¨ì—¬",    
      "rewview.co.kr": "ë¥´ë·°",    
      "popomon": "í¬í¬ëª¬",    
      "4blog": "í¬ë¸”ë¡œê·¸",    
      "dinodan": "ë””ë…¸ë‹¨",    
      "cashnote": "ìºì‹œë…¸íŠ¸",    
      "unnispick.com": "ì–¸ë‹ˆìŠ¤í”½",    
      "mateb.kr": "ê¸°íƒ€ì²´í—˜ë‹¨"          
    };
    //í¬ë¸”ë¡œê·¸, í¬í¬ëª¬, ë””ë…¸ë‹¨, ìºì‹œë…¸íŠ¸ ìš°ë¦¬ê°€ê²Œì²´í—˜ë‹¨, 

    const sponsoredKeywords = [
      "ì œê³µë°›",     // ì œí’ˆì„ ì œê³µë°›ì•„, ì„œë¹„ìŠ¤ ì œê³µë°›ì•„ ë“±
      "ê´‘ê³ ",       // ìœ ë£Œê´‘ê³ , ê´‘ê³ í¬í•¨, ê´‘ê³ ì§€ë§Œ ë“±
      "í˜‘ì°¬",       // í˜‘ì°¬ì„ í†µí•´, í˜‘ì°¬ë°›ì•„ ë“±
      "ë¬´ìƒ",       // ë¬´ìƒì œê³µ, ë¬´ìƒìœ¼ë¡œ ë“±
      "ì œí’ˆì„",     // ì œí’ˆì„ ì œê³µë°›ì•„ ë“±
      "ì—…ì²´ë¡œë¶€í„°", // ì—…ì²´ë¡œë¶€í„° ì œê³µë°›ì•„
      "íŒŒíŠ¸ë„ˆìŠ¤",   // íŒŒíŠ¸ë„ˆìŠ¤ í™œë™
      "ì´ë²¤íŠ¸",     // ì´ë²¤íŠ¸ ë‹¹ì²¨
      "ì˜ë²¤íŠ¸",     // ì˜¤íƒˆì ëŒ€ì‘
      "ìœ ë£Œê´‘ê³ ",   // ëª…ì‹œì  ê´‘ê³  í‘œê¸°
      "ì›ê³ ë£Œ",     // ì›ê³ ë£Œ ì œê³µ ë“±
      "ìˆ˜ìˆ˜ë£Œ",     // ìˆ˜ìˆ˜ë£Œ ì œê³µ, ì§€ê¸‰ ë“±
      "ìˆ™ë°•ê¶Œ",
      "ì²´í—˜ë‹¨",
      "ì²´í—˜",
      "ì‹ì‚¬ê¶Œ",
      "ë‹¹ì²¨ë˜ì–´",
      "ì´ˆëŒ€ê¶Œ",
      "ì œíœ´ë§í¬",
      "ì ë¦½ê¸ˆ",
      "í™ë³´ì§€ì›ê¸ˆ",
      "ê²½ì œì ëŒ€ê°€"
    ];

    const nonSponsoredKeywords =  [
      "ë‚´ëˆë‚´ì‚°",
      "ë‚´ëˆë‚´ë¨¹",
      "ì§ì ‘êµ¬ë§¤",
      "ì§ì ‘ê²°ì œ",
      "ì œëˆìœ¼ë¡œ",
      "ê´‘ê³ ì•„ë‹˜",
      "ê´‘ê³ ì—†ëŠ”",
      "ëŒ€ê°€ì—†ì´"
    ];    

    function isSponsored(text) {
      if (!text) return false;
      return sponsoredKeywords.some(keyword => text.includes(keyword));
    }

    function isNonSponsored(text) {
      if (!text) return false;
      return nonSponsoredKeywords.some(keyword => text.includes(keyword));
    }

    function getDomainAlias(imageUrl) {
      for (const domain in fairDomainAliasMap) {
        if (imageUrl.includes(domain)) {
          return fairDomainAliasMap[domain];
        }
      }
      return "ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ";
    }

    //function renderFairLinks() {
    //  const list = document.getElementById("fairLinkList");
    //  list.innerHTML = "";
    //
    //  Object.entries(fairDomainAliasMap).forEach(([domain, name], idx) => {
    //    const li = document.createElement("li");
    //    li.innerHTML = `${idx + 1}. <strong>${name}</strong> <span class="text-gray-500 text-sm">(${domain})</span>`;
    //    list.appendChild(li);
    //  });
    //}

    function renderFairLinks() {
      const list = document.getElementById("fairLinkList");
      list.innerHTML = "";

      const basePath = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');

      const seenNames = new Set();  // ì¤‘ë³µ ì œê±°ìš©

      Object.entries(fairDomainAliasMap).forEach(([domain, name]) => {
        if (seenNames.has(name)) return;  // ì¤‘ë³µëœ ì´ë¦„ì€ ê±´ë„ˆëœ€
        seenNames.add(name);

        const a = document.createElement("a");
        a.href = `http://${domain}`;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "inline-block box-border p-[5px_8px_6px] border border-gray-200 rounded-[6px] text-center w-20 h-10 flex items-center justify-center text-xs font-semibold text-gray-600";

        a.onclick = (e) => e.preventDefault();  // âœ… ë§í¬ í´ë¦­ ë°©ì§€

        const img = new Image();
        img.src = `${basePath}/img/${name}.png`;
        img.alt = name;
        img.className = "w-full h-full object-contain";

        img.onload = () => {
          a.textContent = "";
          a.appendChild(img);
        };

        img.onerror = () => {
          a.textContent = name;
        };

        list.appendChild(a);
      });
    }

    function renderKeywordTags() {
      const sponsorBox = document.getElementById("sponsoredKeywordTags");
      const nonSponsorBox = document.getElementById("nonSponsoredKeywordTags");

      sponsorBox.innerHTML = "";
      nonSponsorBox.innerHTML = "";

      sponsoredKeywords.forEach(keyword => {
        const span = document.createElement("span");
        span.textContent = keyword;
        span.className = "bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded";
        sponsorBox.appendChild(span);
      });

      nonSponsoredKeywords.forEach(keyword => {
        const span = document.createElement("span");
        span.textContent = keyword;
        span.className = "bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded";
        nonSponsorBox.appendChild(span);
      });
    }


    function showLoading() {
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingText").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingBar").classList.add("hidden");
      document.getElementById("loadingText").classList.add("hidden");
    }

    // ì´ˆê¸° ë Œë”
    renderFairLinks();
    renderKeywordTags();

    function updateProgress(current, total) {
      const percent = (current / total) * progressSplit.analysis;
      document.getElementById("loadingBar").classList.remove("hidden");
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    function updateOcrProgress(current, total) {
      const percent = progressSplit.ocr > 0
        ? progressSplit.analysis + (current / total) * progressSplit.ocr
        : 100;
      document.getElementById("loadingBar").firstElementChild.style.width = `${percent}%`;
    }

    let progressSplit = { analysis: 70, ocr: 30 }; // ê¸°ë³¸ê°’

    let currentViewMode = 'list';
    let globalPostData = []; 

    function setProgressSplit(useDetailedCheck) {
      progressSplit = useDetailedCheck
        ? { analysis: 70, ocr: 30 }
        : { analysis: 100, ocr: 0 };
    }
    // í¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderPosts(posts) {
      //console.log("ğŸ“¦ renderPosts ì§„ì… - í˜„ì¬ ë³´ê¸° ëª¨ë“œ:", currentViewMode);

      const list = document.getElementById("postList");
      list.innerHTML = "";
      console.log('asd');

      if (posts.length === 0) {
        document.getElementById("emptyMessage").classList.remove("hidden");
      } else {
        document.getElementById("emptyMessage").classList.add("hidden");
      }

      function highlightSponsoredKeywords(text) {
        if (!text) return "";
        let safeText = text; // ë³€í˜• ì—†ì´ ì‹œì‘
        sponsoredKeywords.forEach(keyword => {
          const pattern = new RegExp(`(${keyword})`, "gi");
          safeText = safeText.replace(pattern, '<mark class="bg-yellow-200">$1</mark>');
        });
        return safeText;
      }

      function highlightNonSponsoredKeywords(text) {
        if (!text) return "";
        let safeText = text; // ë³€í˜• ì—†ì´ ì‹œì‘
        nonSponsoredKeywords.forEach(keyword => {
          const pattern = new RegExp(`(${keyword})`, "gi");
          safeText = safeText.replace(pattern, '<mark class="bg-yellow-200">$1</mark>');
        });
        return safeText;
      }


      posts.forEach(post => {
        const hasFair = post.fair_trade_img_url;
        const useFairImage = hasFair;// && post.fair_trade_img_position === 1;
        const hasSticker = post.first_image_url?.includes("storep-phinf");

        // âœ… ìš°ì„ ìˆœìœ„: ê³µì •ìœ„ ìƒë‹¨ ì´ë¯¸ì§€ > ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ > ì¼ë°˜ ì¸ë„¤ì¼
        let imageSrc = useFairImage
          ? post.fair_trade_img_url
          : hasSticker
            ? post.first_image_url
            : post.first_image_url;

        if (imageSrc.includes("ê°•ë‚¨ë§›ì§‘.net")) {
          imageSrc = "https://xn--939au0g4vj8sq.net/_sp/wgs.php?ctf=MzE4MDI0fDE3NDEzNDd8YWRtXzI5MzI4Nnw4NjgxMXwyMDI1MDUxNg==";
        }

        if (!useFairImage && imageSrc.includes("type=w") && imageSrc.includes("_blur")) {          
          imageSrc = imageSrc.replace(/type=w\d+_blur/, "type=w800").replace(/([?&])type=w\d+_blur/, "$1type=w800"); // ì¿¼ë¦¬ë„ í¬í•¨ ì²˜ë¦¬
        }

        const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
        const encodedUrl = encodeURIComponent(imageSrc);
        const proxyImageSrc = `${BASE_URL}/proxy?url=${encodedUrl}`;
        const finalImageUrl = useFairImage ? imageSrc : proxyImageSrc;

        // íƒœê·¸ ì •ë¦¬
        const tagList = [];
        const tagTextsForFilter = [];

        const lowerTitle = (post.title || "").toLowerCase();
        const lowerText = (post.first_100_chars || "").toLowerCase();
        const lowerOcr = (post.first_ocr_text || "").toLowerCase();

        const hasSponsoredT = isSponsored(lowerText) || isSponsored(lowerTitle);
        const hasSponsoredO = isSponsored(lowerOcr);

        const hasNonSponsoredT = isNonSponsored(lowerText) || isNonSponsored(lowerTitle);
        const hasNonSponsoredO = isNonSponsored(lowerOcr);

        if (hasFair) {
          if (post.fair_trade_img_position === 1) {
            tagList.push({ text: "ì •ì±… ì§€í‚´ (ê³µì •ìœ„ ì´ë¯¸ì§€)", class: "bg-green-100 text-green-800" });
            tagTextsForFilter.push("ì •ì±… ì§€í‚´");
          } else {
            tagList.push({ text: "ì •ì±… ìœ„ë°˜ (ê³µì •ìœ„ ì´ë¯¸ì§€)", class: "bg-red-100 text-red-800" });
            tagTextsForFilter.push("ì •ì±… ìœ„ë°˜");
          }
        } else if (hasNonSponsoredT || hasNonSponsoredO) {
          tagList.push({ text: "ë‚´ëˆë‚´ì‚°", class: "bg-blue-100 text-blue-800" });
          tagTextsForFilter.push("ë‚´ëˆë‚´ì‚°");
        } else if (hasSponsoredT) {
          tagList.push({ text: "ì •ì±… ì§€í‚´ (í…ìŠ¤íŠ¸)", class: "bg-green-100 text-green-800" });
          tagTextsForFilter.push("ì •ì±… ì§€í‚´");
        } else if (hasSponsoredO) {
          tagList.push({ text: "ì •ì±… ì§€í‚´ (ì´ë¯¸ì§€ OCR)", class: "bg-green-100 text-green-800" });
          tagTextsForFilter.push("ì •ì±… ì§€í‚´");
        } else if (post.first_image_url?.includes("storep-phinf")) {
          tagList.push({ text: "ë¶ˆë¶„ëª… (ìŠ¤í‹°ì»¤)", class: "bg-gray-100 text-gray-700" });
          tagTextsForFilter.push("ë¶ˆë¶„ëª…");
        } else {
          tagList.push({ text: "ë¶ˆë¶„ëª…", class: "bg-gray-200 text-gray-800" });
          tagTextsForFilter.push("ë¶ˆë¶„ëª…");
        }

        // ì¹´ë“œ ìš”ì†Œ ìƒì„±
        const li = document.createElement("li");
        li.className = currentViewMode === 'grid'
          ? "border rounded-md p-2 bg-white shadow-sm flex flex-col text-sm min-h-[110px]"
          : "border rounded-md p-4 mb-4 bg-white shadow-sm";
        li.setAttribute("data-tags", tagTextsForFilter.join(" "));

        const wrapper = document.createElement("div");
        wrapper.className = "flex gap-4 items-start";

        const imageWrapper = document.createElement("div");
        imageWrapper.className = "relative self-center";

        const img = document.createElement("img");
        img.src = finalImageUrl;
        img.alt = "ì¸ë„¤ì¼";
        img.className = useFairImage
          ? "w-20 h-20 sm:w-24 sm:h-24 object-contain bg-gray-100 border rounded-md"
          : "w-20 h-20 sm:w-24 sm:h-24 object-cover bg-gray-100 border rounded-md";
        img.style.userSelect = "none";
        img.onerror = () => { img.style.display = "none"; };

        // âœ… í´ë¦­ ì‹œ ëª¨ë‹¬ ì´ë¯¸ì§€ í™•ëŒ€
        img.addEventListener("click", () => {
          const modal = document.getElementById("imageModal");
          const modalImg = document.getElementById("modalImage");
          modalImg.src = finalImageUrl;
          modal.classList.remove("hidden");
        });

        imageWrapper.appendChild(img);
        wrapper.appendChild(imageWrapper);

        const content = document.createElement("div");
        content.className = "flex-1 overflow-hidden";

        const hasSponsoredInTitle = isSponsored(lowerTitle);
        const hasNonSponsoredInTitle = isNonSponsored(lowerTitle);

        const title = document.createElement("h2");
        title.className = "font-semibold text-sm leading-snug line-clamp-2 overflow-hidden";
        title.innerHTML = `<a href="${post.url}" target="_blank">${
          hasSponsoredInTitle
            ? highlightSponsoredKeywords(post.title)
            : hasNonSponsoredInTitle
              ? highlightNonSponsoredKeywords(post.title)
              : post.title
        }</a>`;

        const date = document.createElement("p");
        date.className = "text-sm text-gray-500 whitespace-nowrap overflow-hidden text-ellipsis";
        date.textContent = post.date;

        content.appendChild(title);
        content.appendChild(date);

        if (currentViewMode === 'list') {
          const summary = document.createElement("p");
          summary.className = "text-xs text-gray-500 mt-1 overflow-hidden";
          summary.style.display = "-webkit-box";
          summary.style.webkitLineClamp = "2";
          summary.style.webkitBoxOrient = "vertical";
          summary.style.lineHeight = "1.2rem";
          summary.style.maxHeight = "2.4rem";
          summary.textContent = post.first_100_chars;

          console.log("ğŸŸ¡ ë””ë²„ê¹… ì‹œì‘ â€” í•˜ì´ë¼ì´íŠ¸ ì¡°ê±´ ì²´í¬");
          console.log("ğŸ“Œ tagTextsForFilter:", tagTextsForFilter);
          console.log("ğŸ“Œ tagList (í…ìŠ¤íŠ¸ ëª©ë¡):", tagList.map(t => t.text));
          console.log("ğŸ“Œ post.first_100_chars:", post.first_100_chars);

          const hasPolicyText = tagTextsForFilter.includes("ì •ì±… ì§€í‚´") && tagList.some(t => t.text.includes("í…ìŠ¤íŠ¸"));
          const hasNonSponText = tagTextsForFilter.includes("ë‚´ëˆë‚´ì‚°");

          console.log("âœ… ì •ì±… ì§€í‚´ + í…ìŠ¤íŠ¸ ì¡°ê±´:", hasPolicyText);
          console.log("âœ… ë‚´ëˆë‚´ì‚° + í…ìŠ¤íŠ¸ ì¡°ê±´:", hasNonSponText);

          if (hasPolicyText) {
            console.log("ğŸŸ¢ í•˜ì´ë¼ì´íŠ¸ ì ìš©: ì •ì±… ì§€í‚´ (í…ìŠ¤íŠ¸)");
            summary.innerHTML = highlightSponsoredKeywords(post.first_100_chars);
          } else if (hasNonSponText) {
            console.log("ğŸ”µ í•˜ì´ë¼ì´íŠ¸ ì ìš©: ë‚´ëˆë‚´ì‚° (í…ìŠ¤íŠ¸)");
            summary.innerHTML = highlightNonSponsoredKeywords(post.first_100_chars);
          } else {
            console.log("âšª í•˜ì´ë¼ì´íŠ¸ ì—†ìŒ: ê¸°ë³¸ í…ìŠ¤íŠ¸ ì¶œë ¥");
            summary.textContent = post.first_100_chars;
          }
          
          content.appendChild(summary);
        }

        const tagContainer = document.createElement("div");
        tagContainer.className = "mt-auto pt-2 flex flex-wrap gap-1";
        tagList.forEach(tag => {
          const span = document.createElement("span");
          span.className = `text-xs px-2 py-0.5 rounded ${tag.class}`;
          span.textContent = tag.text;
          tagContainer.appendChild(span);
        });

        content.appendChild(tagContainer);
        wrapper.appendChild(content);
        li.appendChild(wrapper);
        list.appendChild(li);
      });
    }


    function renderTxt(posts) {
      // ê³µì •ìœ„ ì •ì±… ìœ„ë°˜ íƒœê·¸ê°€ ë¶™ì€ í¬ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
      const groups = {
        "ğŸŸ¢ ì •ì±… ì§€í‚´ (ê³µì •ìœ„ ì´ë¯¸ì§€)": [],
        "ğŸ”´ ì •ì±… ìœ„ë°˜ (ê³µì •ìœ„ ì´ë¯¸ì§€)": [],
        "ğŸŸ¢ ì •ì±… ì§€í‚´ (í…ìŠ¤íŠ¸)": [],
        "ğŸŸ¢ ì •ì±… ì§€í‚´ (ì´ë¯¸ì§€ OCR)": [],
        "ğŸ”µ ë‚´ëˆë‚´ì‚°": [],
        "âšª ë¶ˆë¶„ëª… (ìŠ¤í‹°ì»¤)": [],
        "âšª ë¶ˆë¶„ëª…": []
      };


      posts.forEach(post => {
        const lowerTitle = (post.title || "").toLowerCase();
        const lowerText = (post.first_100_chars || "").toLowerCase();
        const lowerOcr = (post.first_ocr_text || "").toLowerCase();

        const hasSponsoredT = isSponsored(lowerText) || isSponsored(lowerTitle);
        const hasNonSponsoredT = isNonSponsored(lowerText) || isNonSponsored(lowerTitle);
        const hasSponsoredO = isSponsored(lowerOcr);
        const hasNonSponsoredO = isNonSponsored(lowerOcr);

        if (post.fair_trade_img_url) {
          if (post.fair_trade_img_position === 1) {
            groups["ğŸŸ¢ ì •ì±… ì§€í‚´ (ê³µì •ìœ„ ì´ë¯¸ì§€)"].push(post);
          } else {
            groups["ğŸ”´ ì •ì±… ìœ„ë°˜ (ê³µì •ìœ„ ì´ë¯¸ì§€)"].push(post);
          }
        } else if (hasNonSponsoredT || hasNonSponsoredO) {
          groups["ğŸ”µ ë‚´ëˆë‚´ì‚°"].push(post);
        } else if (hasSponsoredT) {
          groups["ğŸŸ¢ ì •ì±… ì§€í‚´ (í…ìŠ¤íŠ¸)"].push(post);
        } else if (hasSponsoredO) {
          groups["ğŸŸ¢ ì •ì±… ì§€í‚´ (ì´ë¯¸ì§€ OCR)"].push(post);
        } else if (post.first_image_url?.includes("storep-phinf")) {
          groups["âšª ë¶ˆë¶„ëª… (ìŠ¤í‹°ì»¤)"].push(post);
        } else {
          groups["âšª ë¶ˆë¶„ëª…"].push(post);
        }
      });

      let txt = `ğŸ“„ [ê³µì •ìœ„ í‘œì‹œ íŒë‹¨ ìš”ì•½ ë³´ê³ ì„œ]\nì´ ${posts.length}ê±´ ë¶„ì„\n\n`;

      for (const [tag, items] of Object.entries(groups)) {
        if (items.length === 0) continue;

        txt += `${tag} - ${items.length}ê±´\n`;
        txt += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

        items.forEach((post, idx) => {
          txt += `${idx + 1}) ${post.title || "(ì œëª© ì—†ìŒ)"}\n`;
          txt += `   ğŸ“ ë§í¬: ${post.url}\n`;
          if (post.fair_trade_img_position)
            txt += `   ğŸ–¼ï¸ ìœ„ì¹˜: ${post.fair_trade_img_position}ë²ˆì§¸\n`;
          txt += `   ğŸ“… ì‘ì„±ì¼: ${post.date || "ì•Œ ìˆ˜ ì—†ìŒ"}\n\n`;
        });

        txt += "\n";
      }

      document.getElementById("reportContent").innerText = txt;
    }

    function downloadTxt() {
      const content = document.getElementById("reportContent").innerText;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fairblog_report.txt";
      a.click();
    }

    function filterByTag(tag) {
      const posts = document.querySelectorAll("#postList li");

      posts.forEach(li => {
        const tags = li.getAttribute("data-tags") || "";

        if (tag === "ì „ì²´" || tags.includes(tag)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    }

    async function runOcrForPost(post) {
      let imageUrl = post.first_image_url;
      //console.log("runOcrForPost imageUrl: ", imageUrl);
      if (!imageUrl || !imageUrl.startsWith("http")) {
        post.first_ocr_text = "";
        return;
      }

      if (/w\d+_blur/.test(imageUrl)) {
        imageUrl = imageUrl.replace(/w\d+_blur/, "w800");
        //console.log("ğŸ”§ ë¸”ëŸ¬ ì œê±°ëœ ì´ë¯¸ì§€ ì£¼ì†Œë¡œ êµì²´:", imageUrl);
      } else {
        //console.log("ğŸ”§ ì´ë¯¸ì§€ì— wXX_blur ì—†ìŒ:", imageUrl);
      }

      // âœ… í”„ë¡ì‹œ URL êµ¬ì„±
      const BASE_URL = location.hostname.includes("localhost") ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const proxyUrl = `${BASE_URL}/proxy?url=${encodeURIComponent(imageUrl)}`;
      console.log(`ğŸ§© OCR ëŒ€ìƒ í”„ë¡ì‹œ ì´ë¯¸ì§€: ${proxyUrl}`);


      const startTime = performance.now();

      try {
        //const { data: { text } } = await Tesseract.recognize(proxyUrl, 'kor', {
        //  logger: m => console.log(`[OCR] ${post.title}: ${m.status} (${Math.round(m.progress * 100)}%)`)
        //});
        const { data: { text } } = await Tesseract.recognize(proxyUrl, 'kor');


        const endTime = performance.now();
        const elapsed = (endTime - startTime).toFixed(1);

        post.first_ocr_text = text.replace(/\s+/g, "");
        console.log(`âœ… OCR ì™„ë£Œ: ${post.title} (${elapsed}ms)`);
        console.log(`ğŸ” OCR ê²°ê³¼:\n${post.first_ocr_text}\n`);
      } catch (err) {
        const failTime = performance.now();
        const elapsed = (failTime - startTime).toFixed(1);
        console.error(`âŒ OCR ì‹¤íŒ¨: ${post.title} (${elapsed}ms)`, err);
        post.first_ocr_text = "";
      }
    }

    function setViewMode(mode) {
      currentViewMode = mode;
      console.log("ğŸ”„ ë³´ê¸° ëª¨ë“œ ë³€ê²½:", currentViewMode);
      const listEl = document.getElementById('postList');
      listEl.className = mode === 'grid'
        ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
        : 'space-y-4';

      const summaryEl = document.getElementById('summaryBox');

      if (mode === 'summary') {
        listEl.style.display = "none";
        summaryEl.style.display = "block";
      } else {
        listEl.style.display = "grid";
        summaryEl.style.display = "none";

        listEl.className = mode === 'grid'
          ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch'
          : 'space-y-4';
      }

      // ë²„íŠ¼ ê°•ì¡° ìŠ¤íƒ€ì¼
      ['btnListView', 'btnGridView', 'btnSummaryView'].forEach(id => {
        document.getElementById(id).classList.remove("bg-blue-600", "text-white");
      });
      const activeBtn = document.getElementById(`btn${capitalize(mode)}View`);
      activeBtn.classList.add("bg-blue-600", "text-white");

      // ğŸ” ë‹¤ì‹œ ëœë”ë§
      renderPosts(globalPostData);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }



    async function fetchBlogPosts() {
      let ocrTotal = 0;
      let ocrCompleted = 0;
      const blogId = document.getElementById("blogId").value.trim();
      const pageNum = parseInt(document.getElementById("pageNum").value || "1");
      const useDetailedCheck = document.getElementById("detailedCheck").checked;
      setProgressSplit(useDetailedCheck);

      if (!blogId) {
        alert("ë„¤ì´ë²„ ë¸”ë¡œê·¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      // ğŸ‘‰ ë²„íŠ¼ ë¹„í™œì„±í™”
      startBtn.disabled = true;
      startBtn.classList.add("opacity-50", "cursor-not-allowed");
      

      const loadingText = document.getElementById("loadingText");
      const loadingBarFill = document.getElementById("loadingBar").firstElementChild;

      // âœ… ë Œë” ì„œë²„ ê¹¨ìš°ê¸° ë©”ì‹œì§€
      loadingText.textContent = "â˜ï¸ ì„œë²„ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 20ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆì–´ìš”)";
      loadingBarFill.style.width = `0%`;
      document.getElementById("loadingText").classList.remove("hidden");
      document.getElementById("loadingBar").classList.remove("hidden");

      showLoading();
      const domainList = Object.keys(fairDomainAliasMap);
      const BASE_URL = isTestMode ? "http://localhost:3000" : "https://fairblog.onrender.com";
      const analyzeSingleUrl = `${BASE_URL}/analyze_single`;
      const postListUrl = `${BASE_URL}/get_post_list`;

      try {
        // â± ì „ì²´ ì‹œê°„ ì¸¡ì • ì‹œì‘
        const startTime = performance.now();

        // ğŸ“¥ 1ë‹¨ê³„: ì„œë²„ì—ì„œ í¬ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ë°›ì•„ì˜¤ê¸°
        const res = await fetch(postListUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogId, pageNum })
        });

        if (!res.ok) throw new Error("ë„¤ì´ë²„ ë¸”ë¡œê·¸ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
        const data = await res.json();
        const items = data.items || [];


        if (items.length === 0) {
          alert("ğŸ“­ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const urls = items.map(item =>
          `https://m.blog.naver.com/${item.domainIdOrBlogId}/${item.logNo}`
        );

        // ğŸ” 2ë‹¨ê³„: ë³‘ë ¬ ë¶„ì„ (nê°œì”©)
        const allPosts = new Array(urls.length); // ê²°ê³¼ ì €ì¥ìš© (ì •ë ¬ ìœ ì§€)
        const batchSize = 24;
        let completed = 0;

        for (let i = 0; i < urls.length; i += batchSize) {
          const batch = urls.slice(i, i + batchSize);

          const tasks = batch.map((postUrl, idx) => {
            const realIdx = i + idx; // ì „ì²´ ì¸ë±ìŠ¤
            return fetch(analyzeSingleUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                postUrl,
                fairTradeImageLinks: domainList
              })
            })
              .then(r => r.ok ? r.json() : null)
              .catch(() => null)
              .then(async result => {
                allPosts[realIdx] = result; // âœ… ìˆœì„œì— ë§ì¶° ì €ì¥
                completed++;
                updateProgress(completed, urls.length);
                loadingText.textContent = `â³ ${completed} / ${urls.length} í¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`;

                
                console.log(`ğŸ“ ê¸€ ì œëª©: ${result.title}`);

                // âœ… ê³µì •ìœ„ ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œë§Œ í…ìŠ¤íŠ¸/OCR ê²€ì‚¬
                if (!result.fair_trade_img_url) {
                  const lowerTitle = (result.title || "").toLowerCase();
                  const lowerText = (result.first_text_block || "").toLowerCase();
                  const imageUrl = result.first_image_url || "";
                  const isMapImage = imageUrl.includes("static.map/v2/map/staticmap.bin");

                  if (isMapImage) {
                    result.first_ocr_text = "";
                  } else if (isSponsored(lowerText) || isSponsored(lowerTitle)) {
                    result.first_ocr_text = "";
                  } else if (isNonSponsored(lowerText) || isNonSponsored(lowerTitle)) {
                    result.first_ocr_text = "";
                  } else if (useDetailedCheck) {
                    // âœ… ìƒì„¸ ê²€ìƒ‰ ON â†’ OCR ì‹¤í–‰
                    ocrTotal++;
                    try {
                      await runOcrForPost(result);
                    } catch (err) {
                      console.warn("âŒ OCR ì‹¤íŒ¨", err);
                    } finally {
                      ocrCompleted++;
                      updateOcrProgress(ocrCompleted, ocrTotal);
                      loadingText.textContent = `ğŸ“¦ í¬ìŠ¤íŠ¸ ë¶„ì„ ì™„ë£Œ â†’ ğŸ“ ì´ë¯¸ì§€ ë¬¸êµ¬ í™•ì¸ ì¤‘ (${ocrCompleted} / ${ocrTotal})`;
                    }
                  } else {
                    // âœ… ìƒì„¸ ê²€ìƒ‰ OFF â†’ ì´ë¯¸ì§€ ê²€ì‚¬ ìƒëµ
                    result.first_ocr_text = "";
                    console.log("ğŸ”‡ OCR ìƒëµë¨ (ìƒì„¸ ê²€ìƒ‰ OFF)");
                  }
                }
              });
          });

          await Promise.allSettled(tasks);
        }

        // ğŸŸ¢ 3ë‹¨ê³„: ê²°ê³¼ ë Œë”ë§
        const filteredPosts = allPosts.filter(p => p !== null);
        globalPostData = filteredPosts;
        renderPosts(globalPostData);
        //renderPosts(allPosts);
        renderTxt(allPosts);
        loadingText.textContent = `âœ… ë¶„ì„ ì™„ë£Œ! ì´ ${allPosts.length}ê±´`;

        // â± ì†Œìš” ì‹œê°„ ë¡œê·¸ ì¶œë ¥
        const endTime = performance.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        const avg = (elapsed / completed).toFixed(2);
        console.log(`âœ… ì „ì²´ ë¶„ì„ ì‹œê°„: ${elapsed}ì´ˆ`);
        console.log(`â± í¬ìŠ¤íŠ¸ë‹¹ í‰ê·  ë¶„ì„ ì‹œê°„: ${avg}ì´ˆ`);

      } catch (err) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", err);
        alert("âš ï¸ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        
        // ğŸ‘‰ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        startBtn.disabled = false;
        startBtn.classList.remove("opacity-50", "cursor-not-allowed");

        hideLoading();
      }
    }
  </script>
  

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      deleteDoc,       // âœ… ì´ ì¤„ ì¶”ê°€!
      doc              // âœ… ì´ ì¤„ë„ í•¨ê»˜ í•„ìš” (ë¬¸ì„œ ì°¸ì¡°ìš©)
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD2EEBetGbTQLhd7EUA21yYGHP0WOk5wIE",
      authDomain: "fairblog-e5054.firebaseapp.com",
      projectId: "fairblog-e5054",
      storageBucket: "fairblog-e5054.firebasestorage.app",
      messagingSenderId: "521579840672",
      appId: "1:521579840672:web:d00975b2bd5255639875c5",
      measurementId: "G-HNBS1KD7JX"
    };

    window.toggleGuestbook = function () {
      const guestbook = document.getElementById("guestbook");
      console.log("í† ê¸€ ì „:", guestbook.className);
      guestbook.classList.toggle("hidden");
      console.log("í† ê¸€ í›„:", guestbook.className);
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app)
    const db = getFirestore(app);
    const auth = getAuth();

    let isAdmin = false;

    document.getElementById("loginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.toggle("hidden");
    };

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("âœ… ë¡œê·¸ì¸ ì„±ê³µ");
        document.getElementById("loginFormBox").classList.add("hidden");
      } catch (err) {
        alert("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message);
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("loginFormBox").classList.add("hidden");
      }
    });

    document.getElementById("closeLoginBtn").onclick = () => {
      document.getElementById("loginFormBox").classList.add("hidden");
    };
    
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("ğŸšª ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤");
    };

    // âœ… Auth ìƒíƒœ ê°ì§€ â†’ startGuestbookListener í˜¸ì¶œ
    onAuthStateChanged(auth, async (user) => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (!loginBtn || !logoutBtn) {
        console.warn("â— loginBtn ë˜ëŠ” logoutBtn ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        //console.log("âœ… ë¡œê·¸ì¸ë¨:", user.email);
        //console.log("ğŸ›¡ isAdmin:", isAdmin);

        // âœ… ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¹€, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

      } else {
        isAdmin = false;

        // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¹€
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }

      const nicknameInput = document.getElementById("nickname");
      if (user) {
        const token = await user.getIdTokenResult();
        isAdmin = !!token.claims.admin;

        if (isAdmin) {
          nicknameInput.value = "ê´€ë¦¬ì";
          nicknameInput.disabled = true;
        } else {
          nicknameInput.disabled = false;
        }
      } else {
        isAdmin = false;
        nicknameInput.disabled = false;
      }

      startGuestbookListener(); // â† ì—¬ê¸°ì„œ UI ë‹¤ì‹œ ë Œë”
    });

    // âœ… ì´ ë¶€ë¶„ì´ ì‹¤ì‹œê°„ ë°©ëª…ë¡ ë¦¬ìŠ¤ë„ˆ ì •ì˜
    function startGuestbookListener() {
      const q = query(
        collection(db, "guestbook"),
        orderBy("timestamp", "asc"),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        const list = document.getElementById("guestbookList");
        list.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");



          // âœ… ê´€ë¦¬ì ë‹‰ë„¤ì„ ìŠ¤íƒ€ì¼ë§
          const isAdminMessage = data.nickname === "ê´€ë¦¬ì";

          const timestamp = data.timestamp?.toDate?.();
          const dateText = timestamp
            ? timestamp.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              })
            : 'ì‘ì„±ì¼ì ì—†ìŒ';

          li.className = "border-b py-2 text-sm text-left";

          li.innerHTML = `
            <div class="text-sm text-gray-800 break-words leading-snug">
              <span class="${isAdminMessage ? 'text-blue-600 font-bold' : 'font-medium'}">
                ğŸ§‘ ${data.nickname}:
              </span>
              <span>${data.message}</span>
            </div>
            <div class="text-xs text-gray-500 mt-0.5 text-right w-full">
              ğŸ•’ ${dateText}
            </div>
          `;

          // âœ… ì‚­ì œ ë²„íŠ¼ì€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¼ ë•Œë§Œ
          if (isAdmin) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "ì‚­ì œ";
            delBtn.className = "text-xs text-red-500 hover:underline ml-2";
            delBtn.onclick = async () => {
              if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "guestbook", docSnap.id));
              }
            };
            li.appendChild(delBtn);
          }

          list.appendChild(li);
        });
      });
    }

    function generateRandomNickname() {
      const adjectives = ["ê·€ì—¬ìš´", "ëŠê¸‹í•œ", "í™œë°œí•œ", "ìš©ê°í•œ", "ìš°ì•„í•œ", "ë¹ ë¥¸", "ì¡°ìš©í•œ", "ì—‰ëš±í•œ"];
      const animals = ["í† ë¼", "ê³ ì–‘ì´", "ê°•ì•„ì§€", "íŒë‹¤", "ìˆ˜ë‹¬", "ì—¬ìš°", "í•˜ë§ˆ", "ë‹¤ëŒì¥"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      return `${adj} ${animal}`;
    }
    
    // âœ… ë°©ëª…ë¡ ì‘ì„± ì²˜ë¦¬
    const form = document.getElementById("guestbookForm");
    const nicknameInput = document.getElementById("nickname");
    const messageInput = document.getElementById("message");
    const list = document.getElementById("guestbookList");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let nickname = nicknameInput.value.trim();
      const message = messageInput.value.trim();
      if (!message) return;

      // âœ… ê´€ë¦¬ìì¼ ê²½ìš° ë‹‰ë„¤ì„ì€ ê³ ì •
      if (isAdmin) {
        nickname = "ê´€ë¦¬ì";
      }

      // âœ… ì¼ë°˜ ì‚¬ìš©ìëŠ” "ê´€ë¦¬ì" ë‹‰ë„¤ì„ ê¸ˆì§€
      if (nickname === "ê´€ë¦¬ì" && !isAdmin) {
        alert("âŒ 'ê´€ë¦¬ì'ë¼ëŠ” ë‹‰ë„¤ì„ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ë¹„ì–´ ìˆê±°ë‚˜ ìë™ ì…ë ¥ ì‹œ ëœë¤ ìƒì„±
      if (!nickname) {
        nickname = generateRandomNickname();
      }

      try {
        await addDoc(collection(db, "guestbook"), {
          nickname,
          message,
          timestamp: serverTimestamp()
        });
        messageInput.value = "";
      } catch (err) {
        console.error("ğŸ”¥ ë°©ëª…ë¡ ì €ì¥ ì‹¤íŒ¨:", err);
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const nicknameInput = document.getElementById("nickname");
      if (!nicknameInput.value) {
        nicknameInput.value = generateRandomNickname();  // âœ… ì‹¤ì œ ì…ë ¥ê°’ìœ¼ë¡œ ì„¤ì •
      }

      const guestbook = document.getElementById("guestbook");
      if (window.innerWidth < 640) {
        guestbook.classList.add("hidden");
      } else {
        guestbook.classList.remove("hidden");
      }

      setViewMode('list'); // ë³´ê¸° ëª¨ë“œ ì´ˆê¸°í™” (ë¦¬ìŠ¤íŠ¸ë¡œ)

    });

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('imageModal').classList.add('hidden');
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const check = document.getElementById("detailedCheck");

      check.addEventListener("change", () => {
        if (check.checked) {
          alert(
            "âœ… ìƒì„¸ ê²€ìƒ‰ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
            "ê³µì •ìœ„ ë„ë©”ì¸ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš°,\nëŒ€í‘œ ì´ë¯¸ì§€(ì²« ë²ˆì§¸ ì´ë¯¸ì§€) ì† ë¬¸êµ¬ê¹Œì§€ ìë™ìœ¼ë¡œ ê²€ì‚¬í•©ë‹ˆë‹¤.\n\n" +
            "í…ìŠ¤íŠ¸ì— ëª…ì‹œë˜ì§€ ì•Šì€ ìŠ¤í‹°ì»¤(ì˜ˆ: 'ì œê³µë°›ìŒ')ê°€ í¬í•¨ëœ ê²½ìš°ì—ë„ ì¼ë¶€ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
            "ë‹¨, ì´ë¯¸ì§€ì˜ ê¸€ìê°€ ë„ˆë¬´ ì‘ê±°ë‚˜ íŠ¹ì´í•œ ê¸€ê¼´ì¸ ê²½ìš°\nì •í™•í•œ ì¸ì‹ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
          } else {
          alert(
            "â„¹ï¸ ìƒì„¸ ê²€ìƒ‰ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
            "ê³µì •ìœ„ ë„ë©”ì¸ ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë§Œ ë¶„ì„í•©ë‹ˆë‹¤."
          );         
        }
      });
    });


  </script>
</body>
</html>
